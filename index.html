<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gaming Tournament</title>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Updated Font Awesome link to ensure all icons from new login page are available -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- ORIGINAL CSS Styles (Only root variables changed for new theme mapping) --- */
        :root {
            --primary-bg: #0F172A;
            /* Dark blue-gray */
            --secondary-bg: #1E293B;
            /* Slightly lighter blue-gray */
            --card-bg: #1E293B;
            --text-primary: #E2E8F0;
            /* Light gray for primary text */
            --text-secondary: #94A3B8;
            /* Muted gray for secondary text */
            --accent-color: #FACC15;
            /* Yellow accent */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6;
            /* Blue for primary actions */
            --border-color: #334155;
            /* Border color */
            --bottom-nav-bg: #1E293B;
            --success-color: #10B981;
            /* Green for success */
            --danger-color: #EF4444;
            /* Red for danger/errors */
            --warning-color: #F59E0B;
            /* Orange for warnings */
            --info-color: #3B82F6;
            /* Blue for info */

            /* --- NEW LOGIN PAGE VARIABLES FOR CSS --- */
            --cord: #333;
            --tongue: #ffcc00;
            --primary: #4a6cf7;
            /* New primary color for login form (light blue) */
            --primary-dark: #3a5bd9;
            --primary-light: #eef2ff;
            --light: #f5f8ff;
            --dark: #1e1e1e;
            --gray: #888;
            --gray-light: #e0e0e0;
            --success-new: #4CAF50;
            /* New success color */
            --error-new: #f44336;
            /* New error color */
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            padding-top: 70px;
            /* Space for fixed header */
            padding-bottom: 75px;
            /* Space for fixed bottom nav */
            min-height: 100vh;
            overscroll-behavior-y: contain;
            position: relative;
        }

        /* --- FIX: CSS for Login Page Overlapping --- */
        /* 1. Hide fixed header and bottom nav when login is active */
        body.login-active .app-header,
        body.login-active .bottom-nav {
            display: none;
        }

        /* 2. Remove body padding and use flex to center login section content */
        body.login-active {
            padding-top: 0;
            padding-bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* 3. Ensure main-content uses full available space and centers its content */
        body.login-active .main-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            /* Center login form vertically */
            justify-content: center;
            /* Center login form horizontally */
            padding: 0;
            /* Remove default 15px padding */
        }

        /* 4. Ensure login section takes up the needed space and center wrapper is flex */
        #login-section.section.active {
            display: block !important;
            animation: none;
            width: 100%;
            height: 100%;
        }

        .auth-container-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* --- END FIX --- */


        a {
            color: var(--accent-color);
            text-decoration: none;
        }

        a:hover {
            color: #FBBF24;
        }

        .main-content {
            padding: 15px;
            position: relative;
            z-index: 1;
            /* Lower z-index to allow fixed elements to overlay if needed */
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            position: relative;
            z-index: 1;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .custom-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .btn-custom {
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 15px;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: background-color 0.2s ease, filter 0.2s ease;
        }

        .btn-custom-primary {
            background-color: var(--primary-button-bg);
            color: var(--text-primary);
        }

        .btn-custom-primary:hover {
            background-color: #2563EB;
        }

        .btn-custom-secondary {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-custom-secondary:hover {
            background-color: #334155;
        }

        .btn-custom-accent {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            font-weight: 600;
        }

        .btn-custom-accent:hover {
            filter: brightness(1.1);
        }

        .btn-custom-link {
            background: none;
            border: none;
            color: var(--primary-button-bg);
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0;
            cursor: pointer;
        }

        .text-accent {
            color: var(--accent-color);
        }

        .text-success {
            color: var(--success-color);
        }

        .text-danger {
            color: var(--danger-color);
        }

        .text-warning {
            color: var(--warning-color);
        }

        .text-info {
            color: var(--info-color);
        }

        .form-control {
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
        }

        .form-control:focus {
            background-color: var(--primary-bg);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25);
            outline: 0;
        }

        .form-control::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .form-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .alert {
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .list-group-item {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: none;
            border-bottom: 1px solid var(--border-color);
            padding: 15px;
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
        }

        /* ADDED: Styling for 'NEW' notification item */
        .list-group-item.bg-secondary {
            background-color: var(--primary-bg);
            border-left: 3px solid var(--accent-color);
        }

        .list-group-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .list-group-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .list-group-item i:first-child {
            color: var(--accent-color);
            margin-right: 15px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .list-group-item .bi-chevron-right {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        #globalLoaderEl {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .spinner-border {
            color: var(--accent-color);
            width: 3rem;
            height: 3rem;
        }

        .placeholder-glow .placeholder {
            background-color: rgba(51, 65, 85, 0.5);
            animation: placeholder-glow 2s ease-in-out infinite;
        }

        .placeholder {
            background-color: rgba(51, 65, 85, 0.5);
            border-radius: 4px;
        }

        @keyframes placeholder-glow {
            0% {
                background-color: rgba(51, 65, 85, 0.5);
            }

            50% {
                background-color: rgba(51, 65, 85, 0.7);
            }

            100% {
                background-color: rgba(51, 65, 85, 0.5);
            }
        }

        .interactive-list-item {
            cursor: pointer;
        }

        .referral-code {
            font-family: monospace;
            letter-spacing: 1px;
            user-select: all;
        }

        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: var(--secondary-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fff;
            object-fit: cover;
            border: 1px solid var(--accent-color);
        }

        .header-title {
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1.2;
        }

        .header-title span {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: block;
        }

        .header-back-button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.4rem;
            margin-right: 5px;
            display: none;
            padding: 5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-icon {
            font-size: 1.3rem;
            color: var(--text-primary);
            position: relative;
            background: none;
            border: none;
            padding: 0;
        }

        .notification-badge {
            position: absolute;
            top: -3px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            font-size: 0.6rem;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .wallet-chip {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            padding: 5px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 700;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .wallet-chip i {
            margin-right: 5px;
            font-size: 0.9rem;
        }

        .header-game-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-left: 10px;
            display: none;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px;
            background-color: var(--bottom-nav-bg);
            display: flex;
            justify-content: space-around;
            align-items: stretch;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-top: 1px solid var(--border-color);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-decoration: none;
            flex-grow: 1;
            padding: 8px 0;
            transition: color 0.2s ease, background-color 0.2s ease;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .nav-item i {
            font-size: 1.4rem;
            margin-bottom: 4px;
            line-height: 1;
        }

        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
            line-height: 1;
        }

        .nav-item.active {
            color: var(--accent-color);
            background-color: rgba(250, 204, 21, 0.1);
        }

        .swiper-container#promotionSliderEl {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            margin-bottom: 25px;
            --swiper-pagination-color: var(--accent-color);
            --swiper-pagination-bullet-inactive-color: var(--text-secondary);
            --swiper-pagination-bullet-size: 8px;
        }

        .swiper-slide {
            background-color: var(--secondary-bg);
            border-radius: 10px;
        }

        .swiper-slide img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .game-card {
            text-align: center;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            padding: 0;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .game-card img {
            width: 100%;
            height: 130px;
            object-fit: cover;
            display: block;
        }

        .game-card span {
            display: block;
            padding: 10px 5px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .tournament-tabs {
            display: flex;
            justify-content: space-around;
            background-color: var(--secondary-bg);
            padding: 5px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .tab-item {
            color: var(--text-secondary);
            background: none;
            border: none;
            padding: 8px 10px;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 6px;
            flex-grow: 1;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .tab-item.active {
            background-color: var(--primary-button-bg);
            color: var(--text-primary);
        }

        .tab-item i {
            margin-right: 5px;
        }

        .tournament-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        .tournament-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tournament-card-tags span {
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            font-size: 0.7rem;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            border: 1px solid var(--border-color);
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .tournament-card-timer {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 0.75rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .tournament-card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        .tournament-card-title i {
            color: var(--accent-color);
        }

        .tournament-card-info {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            border-top: 1px dashed var(--border-color);
            border-bottom: 1px dashed var(--border-color);
            padding: 10px 0;
            margin: 10px 0;
            font-size: 0.8rem;
        }

        .info-item {
            text-align: center;
            flex: 1;
            padding: 0 5px;
        }

        .info-item span {
            display: block;
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin-bottom: 2px;
        }

        .info-item strong {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .info-item .prize-icon {
            color: var(--accent-color);
            font-size: 1.2rem;
        }

        .tournament-card-spots {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .tournament-card-spots span {
            font-weight: 600;
        }

        .progress {
            height: 6px;
            background-color: var(--primary-bg);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            background-color: var(--warning-color);
            transition: width 0.3s ease;
        }

        .tournament-card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .tournament-card-actions .btn-sm {
            padding: 8px 10px;
            font-size: 0.85rem;
            width: 100%;
        }

        .tournament-card-actions .btn-join {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            font-weight: 600;
            grid-column: 2 / 3;
        }

        .tournament-card-actions .btn-details {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            grid-column: 1 / 2;
        }

        .tournament-card-actions .btn-joined {
            background-color: var(--success-color);
            color: var(--text-primary);
            opacity: 0.8;
            grid-column: 2 / 3;
        }

        .tournament-card-actions .btn-disabled {
            background-color: var(--secondary-bg);
            opacity: 0.6;
            cursor: not-allowed;
            grid-column: 2 / 3;
        }

        .btn-idpass {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            border: none;
            font-weight: 600;
        }

        .wallet-card {
            background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg));
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .wallet-card h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .balance-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        .balance-item-label {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .balance-item-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .balance-item-action {
            min-width: 100px;
            text-align: right;
        }

        .balance-item-action .btn-custom-link {
            font-size: 0.85rem;
            color: var(--accent-color);
            padding: 5px;
        }

        .balance-item-action .btn-withdraw {
            background-color: var(--primary-button-bg);
            color: #fff;
            font-size: 0.8rem;
            padding: 5px 12px;
            border-radius: 5px;
            border: none;
        }

        #recentTransactionsListEl .custom-card {
            background-color: var(--secondary-bg);
        }

        #earnings-section .custom-card {
            text-align: center;
        }

        #earnings-section .display-4 {
            font-size: 3rem;
        }

        #earnings-section p strong {
            color: var(--text-primary);
        }

        .profile-header-card {
            background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg));
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .profile-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid var(--accent-color);
            object-fit: cover;
            background-color: var(--primary-bg);
        }

        .profile-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .profile-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            word-break: break-all;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-item strong {
            display: block;
            font-size: 1rem;
            font-weight: 600;
        }

        .stat-item span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .profile-links .list-group {
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .profile-links .form-switch .form-check-input {
            background-color: var(--secondary-bg);
            border-color: var(--border-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 0.25%29'/%3e%3c/svg%3e");
        }

        .profile-links .form-switch .form-check-input:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
        }



        .auth-container-wrapper .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 440px;
            padding: 0 15px;
        }

        .auth-container-wrapper .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 100%;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            margin-bottom: 0;
            padding: 0;
            position: relative;
            z-index: 2;
        }

        .auth-container-wrapper .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }

        .auth-container-wrapper .lamp-container {
            position: relative;
            margin-bottom: 20px;
            height: 180px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background: linear-gradient(135deg, var(--primary-light) 0%, #ffffff 100%);
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 20px;
        }

        .auth-container-wrapper .lamp {
            height: 40vmin;
            max-height: 130px;
            overflow: visible !important;
            z-index: 2;
            transition: transform 0.3s ease;
        }

        .auth-container-wrapper .lamp:hover {
            transform: scale(1.05);
        }

        .auth-container-wrapper .cord {
            stroke: var(--cord);
            stroke-width: 2;
        }

        .auth-container-wrapper .lamp-base {
            fill: #4a5568;
        }

        .auth-container-wrapper .lamp-shade {
            fill: #718096;
        }

        .auth-container-wrapper .lamp_tongue {
            fill: var(--tongue);
            opacity: 0;
            transition: opacity 0.5s ease;
            filter: url(#glow);
        }

        .auth-container-wrapper .light-beam {
            position: absolute;
            bottom: 0;
            width: 120px;
            height: 0;
            background: radial-gradient(ellipse at center, rgba(255, 204, 0, 0.4) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(15px);
            transition: height 0.5s ease, background 0.5s ease;
            z-index: 1;
        }

        .auth-container-wrapper .mode-toggle {
            display: flex;
            background: var(--primary-light);
            border-radius: 50px;
            padding: 6px;
            margin: 0 30px 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 1;
        }

        .auth-container-wrapper .mode-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray);
            position: relative;
            z-index: 2;
        }

        .auth-container-wrapper .mode-btn.active {
            color: var(--primary);
        }

        .auth-container-wrapper .active-slider {
            position: absolute;
            top: 6px;
            left: 6px;
            height: calc(100% - 12px);
            width: calc(50% - 6px);
            background: white;
            border-radius: 25px;
            box-shadow: 0 4px 10px rgba(74, 108, 247, 0.2);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1;
        }

        .auth-container-wrapper .active-slider.signup {
            transform: translateX(100%);
        }

        .auth-container-wrapper .form-container {
            position: relative;
            width: 100%;
            height: 420px;
            overflow: hidden;
        }

        @media (max-height: 750px) {
            .auth-container-wrapper .form-container {
                height: 380px;
            }
        }

        .auth-container-wrapper .form {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 0 30px 30px;
            background: white;
            transition: transform 0.5s ease, opacity 0.5s ease;
            opacity: 0;
            transform: translateX(100%);
            display: flex;
            flex-direction: column;
        }

        .auth-container-wrapper .form.active {
            opacity: 1;
            transform: translateX(0);
        }

        .auth-container-wrapper .form-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--dark);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .auth-container-wrapper .form-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* Custom scrollbar */
        .auth-container-wrapper .form-content::-webkit-scrollbar {
            width: 6px;
        }

        .auth-container-wrapper .form-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .auth-container-wrapper .form-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .auth-container-wrapper .form-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        .auth-container-wrapper .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .auth-container-wrapper .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .auth-container-wrapper .form-input-container {
            position: relative;
        }

        /* Overriding original .form-control styles for new login form inputs */
        .auth-container-wrapper .form-input {
            width: 100%;
            padding: 14px 50px 14px 45px;
            border: 1.5px solid var(--gray-light);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            color: var(--dark);
        }

        .auth-container-wrapper .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.15);
            outline: none;
        }

        .auth-container-wrapper .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            transition: color 0.3s ease;
            z-index: 2;
        }

        .auth-container-wrapper .form-input:focus+.input-icon {
            color: var(--primary);
        }

        .auth-container-wrapper .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            background: none;
            border: none;
            font-size: 1rem;
            z-index: 2;
        }

        .auth-container-wrapper .password-toggle:hover {
            color: var(--primary);
            transform: translateY(-50%) scale(1.1);
        }

        .auth-container-wrapper .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 108, 247, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .auth-container-wrapper .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 108, 247, 0.4);
        }

        .auth-container-wrapper .submit-btn:active {
            transform: translateY(0);
        }

        .auth-container-wrapper .submit-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .auth-container-wrapper .submit-btn:hover::after {
            left: 100%;
        }

        .auth-container-wrapper .form-footer {
            margin-top: 1.5rem;
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid var(--gray-light);
            flex-shrink: 0;
        }

        .auth-container-wrapper .forgot-link {
            color: var(--gray);
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .auth-container-wrapper .forgot-link:hover {
            color: var(--primary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(150%);
            transition: transform 0.5s ease;
            z-index: 10000;
            max-width: 350px;
            color: var(--dark);
            /* Notification text color */
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success-new);
        }

        .notification.error {
            border-left: 4px solid var(--error-new);
        }

        .notification i {
            font-size: 1.3rem;
        }

        .success i {
            color: var(--success-new);
        }

        .error i {
            color: var(--error-new);
        }

        .auth-container-wrapper .password-strength-container {
            margin-top: 8px;
        }

        .auth-container-wrapper .password-strength {
            height: 6px;
            border-radius: 3px;
            background: #eee;
            overflow: hidden;
            position: relative;
            margin-bottom: 5px;
        }

        .auth-container-wrapper .strength-bar {
            height: 100%;
            width: 0;
            transition: width 0.4s ease, background 0.4s ease;
            border-radius: 3px;
        }

        .auth-container-wrapper .strength-text {
            font-size: 0.75rem;
            color: var(--gray);
            text-align: right;
            font-weight: 500;
        }

        .auth-container-wrapper .social-login {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .auth-container-wrapper .social-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1.5px solid var(--gray-light);
            color: var(--gray);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-container-wrapper .social-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .auth-container-wrapper .social-btn.google:hover {
            color: #DB4437;
            border-color: #DB4437;
        }

        .auth-container-wrapper .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .auth-container-wrapper .remember-me input {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .auth-container-wrapper .remember-me label {
            font-size: 0.9rem;
            color: var(--gray);
            cursor: pointer;
        }

        .auth-container-wrapper .terms {
            font-size: 0.8rem;
            color: var(--gray);
            text-align: center;
            margin-top: 15px;
            line-height: 1.4;
        }

        .auth-container-wrapper .terms a {
            color: var(--primary);
            text-decoration: none;
        }

        .auth-container-wrapper .terms a:hover {
            text-decoration: underline;
        }

        .auth-container-wrapper .password-requirements {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 5px;
            line-height: 1.4;
        }

        @media (max-width: 480px) {
            .auth-container-wrapper .form {
                padding: 0 20px 20px;
            }

            .auth-container-wrapper .lamp-container {
                height: 150px;
            }

            .auth-container-wrapper .form-container {
                height: 450px;
            }

            .auth-container-wrapper .mode-toggle {
                margin: 0 20px 20px;
            }
        }

        /* Modal Styles */
        .modal-content {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            border-bottom-color: var(--border-color);
        }

        .modal-footer {
            border-top-color: var(--border-color);
        }

        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        .modal-body .phonepe-number {
            color: var(--warning-color);
            font-weight: bold;
            user-select: text;
        }

        #matchDetailsModalBodyEl pre {
            background-color: var(--primary-bg);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #policyModalBodyEl {
            line-height: 1.6;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }

        #policyModalBodyEl .copy-btn,
        #policyModalBodyEl #shareReferralBtn {
            padding: 4px 10px;
            font-size: 0.9rem;
        }

        #policyModalBodyEl #shareReferralBtn i,
        #policyModalBodyEl .copy-btn i {
            margin-right: 5px;
        }

        #securityWarning {
            background-color: var(--danger-color);
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-size: 0.9rem;
            position: sticky;
            top: 60px;
            z-index: 999;
            border-bottom: 1px solid #a51d1d;
        }

        #securityWarning a {
            color: #ffdddd;
            text-decoration: underline;
        }

        #securityWarning button {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 2px 8px;
            margin-left: 15px;
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Hide Google Sign In Button */
        #googleSignInBtnMainEl {
            display: none;
        }
    </style>
</head>

<body class="login-active">
    <!-- Firebase Security Rules Warning -->
    <div id="securityWarning" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Security Alert:</strong> Your database rules are
        insecure (public). Anyone can read/write data.
        <a href="https://firebase.google.com/docs/database/security" target="_blank"
            rel="noopener noreferrer">Learn how to secure rules.</a>
        <button onclick="this.parentElement.style.display='none'">Dismiss</button>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button>
            <img src="https://via.placeholder.com/40/FFFFFF/0F172A?text=G" alt="Logo" class="header-logo"
                id="appLogoEl">
            <div class="header-title" id="headerTitleContainerEl"> Welcome <span id="headerUserGreetingEl">Guest</span>
            </div>
            <div class="header-game-title" id="headerGameTitleEl">Game Title</div>
        </div>
        <div class="header-right">
            <button class="notification-icon" id="notificationBtnEl"> <i class="bi bi-bell-fill"></i> <span
                    class="notification-badge" style="display: none;"></span> </button>
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;"> <i
                    class="bi bi-wallet-fill"></i> ₹<span id="headerChipBalanceEl">0</span> </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div id="globalLoaderEl">
            <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>

        <!-- Login Section (REPLACED WITH NEW DESIGN) -->
        <section id="login-section" class="section active">
            <div class="auth-container-wrapper">
                <div class="container">
                    <div class="card">
                        <!-- Lamp SVG -->
                        <div class="lamp-container" id="lampToggle">
                            <svg class="lamp" viewBox="0 0 100 150">
                                <defs>
                                    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                        <feGaussianBlur stdDeviation="3" result="coloredBlur" />
                                        <feMerge>
                                            <feMergeNode in="coloredBlur" />
                                            <feMergeNode in="SourceGraphic" />
                                        </feMerge>
                                    </filter>
                                </defs>
                                <line class="cord" x1="50" y1="0" x2="50" y2="30" />
                                <rect class="lamp-base" x="35" y="30" width="30" height="10" rx="2" />
                                <path class="lamp-shade" d="M30 40 L70 40 L80 80 L20 80 Z" />
                                <circle class="lamp_tongue" cx="50" cy="85" r="15" />
                            </svg>
                            <div class="light-beam"></div>
                        </div>

                        <!-- Mode Toggle -->
                        <div class="mode-toggle">
                            <div class="active-slider"></div>
                            <button class="mode-btn active" data-mode="login">Login</button>
                            <button class="mode-btn" data-mode="signup">Sign Up</button>
                        </div>

                        <!-- Forms Container -->
                        <div class="form-container">
                            <!-- Login Form (Original ID used: emailLoginForm) -->
                            <form class="form active" id="emailLoginForm">
                                <h2 class="form-title">Welcome Back</h2>
                                <div class="form-content">
                                    <div class="form-group">
                                        <label class="form-label" for="loginEmailInputEl">Username or Email</label>
                                        <div class="form-input-container">
                                            <!-- ID Mapped from new 'username' to old 'loginEmailInputEl' -->
                                            <input class="form-input" type="text" id="loginEmailInputEl"
                                                placeholder="Enter your username or email" required>
                                            <i class="fas fa-user input-icon"></i>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="loginPasswordInputEl">Password</label>
                                        <div class="form-input-container">
                                            <!-- ID Mapped from new 'password' to old 'loginPasswordInputEl' -->
                                            <input class="form-input" type="password" id="loginPasswordInputEl"
                                                placeholder="Enter your password" required>
                                            <i class="fas fa-lock input-icon"></i>
                                            <button type="button" class="password-toggle" id="toggleLoginPassword">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Firebase Status Message (Crucial for errors, kept hidden) -->
                                    <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>

                                    <div class="remember-me">
                                        <input type="checkbox" id="remember">
                                        <label for="remember">Remember me</label>
                                    </div>

                                    <!-- Firebase Login Button (ID Mapped from new 'loginBtn' to old 'loginEmailBtnEl') -->
                                    <button type="button" class="submit-btn" id="loginEmailBtnEl">
                                        <i class="fas fa-sign-in-alt"></i> Login
                                    </button>

                                    <div class="social-login">
                                        <!-- Keeping original Google ID for future integration -->
                                        <div class="social-btn google" id="googleSignInBtnMainEl">
                                            <i class="fab fa-google"></i>
                                        </div>
                                        <div class="social-btn facebook" style="display: none;"><i
                                                class="fab fa-facebook-f"></i></div>
                                        <div class="social-btn twitter" style="display: none;"><i
                                                class="fab fa-twitter"></i></div>
                                    </div>
                                </div>

                                <div class="form-footer">
                                    <!-- Firebase Forgot Password Link (Original ID used: forgotPasswordLinkEl) -->
                                    <a href="#" class="forgot-link" id="forgotPasswordLinkEl">Forgot Password?</a>
                                </div>
                            </form>

                            <!-- Signup Form (Original ID used: emailSignupForm) -->
                            <form class="form" id="emailSignupForm">
                                <h2 class="form-title">Create Account</h2>
                                <div class="form-content">

                                    <div class="form-group">
                                        <label class="form-label" for="signupEmailInputEl">Email Address</label>
                                        <div class="form-input-container">
                                            <!-- ID Mapped from new 'email' to old 'signupEmailInputEl' -->
                                            <input class="form-input" type="email" id="signupEmailInputEl"
                                                placeholder="Enter your email" required>
                                            <i class="fas fa-envelope input-icon"></i>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="signupPasswordInputEl">Password</label>
                                        <div class="form-input-container">
                                            <!-- ID Mapped from new 'newPassword' to old 'signupPasswordInputEl' -->
                                            <input class="form-input" type="password" id="signupPasswordInputEl"
                                                placeholder="Create a password" required minlength="6">
                                            <i class="fas fa-lock input-icon"></i>
                                            <button type="button" class="password-toggle" id="toggleNewPassword">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="password-strength-container">
                                            <div class="password-strength">
                                                <div class="strength-bar" id="passwordStrength"></div>
                                            </div>
                                            <div class="strength-text" id="strengthText">Very Weak</div>
                                        </div>
                                        <div class="password-requirements">
                                            Use 6+ characters. (Strength indicator is cosmetic in this implementation)
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="signupConfirmPasswordInputEl">Confirm
                                            Password</label>
                                        <div class="form-input-container">
                                            <!-- ID Mapped from new 'confirmPassword' to old 'signupConfirmPasswordInputEl' -->
                                            <input class="form-input" type="password" id="signupConfirmPasswordInputEl"
                                                placeholder="Confirm your password" required>
                                            <i class="fas fa-lock input-icon"></i>
                                            <button type="button" class="password-toggle" id="toggleConfirmPassword">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- REFERRAL CODE INPUT RE-ADDED (CRUCIAL FOR FIREBASE LOGIC) -->
                                    <div class="form-group">
                                        <label class="form-label" for="signupReferralCodeInputEl">Referral Code
                                            (Optional)</label>
                                        <div class="form-input-container">
                                            <input class="form-input" type="text" id="signupReferralCodeInputEl"
                                                placeholder="Enter referral code">
                                            <i class="fas fa-gift input-icon"></i>
                                        </div>
                                    </div>

                                    <!-- Firebase Status Message (Crucial for errors, kept hidden) -->
                                    <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>

                                    <div class="terms">
                                        By creating an account, you agree to our <a href="#" data-policy="terms">Terms of
                                            Service</a> and <a href="#" data-policy="privacy">Privacy Policy</a>
                                    </div>

                                    <!-- Firebase Signup Button (ID Mapped from new 'signupBtn' to old 'signupEmailBtnEl') -->
                                    <button type="button" class="submit-btn" id="signupEmailBtnEl">
                                        <i class="fas fa-user-plus"></i> Create Account
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <!-- Promotion Slider -->
            <div class="swiper-container" id="promotionSliderEl">
                <div class="swiper-wrapper placeholder-glow">
                    <div class="swiper-slide"><span class="placeholder"
                            style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div>
                </div>
                <div class="swiper-pagination"></div>
            </div>

            <!-- Esport Games -->
            <h2 class="section-title">Esport Games</h2>
            <div class="row g-3 mb-4 placeholder-glow" id="gamesListEl">
                <!-- Placeholder Game Cards -->
                <div class="col-6">
                    <div class="game-card custom-card"><span class="placeholder d-block"
                            style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span
                            class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div>
                </div>
                <div class="col-6">
                    <div class="game-card custom-card"><span class="placeholder d-block"
                            style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span
                            class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div>
                </div>
            </div>

            <!-- My Contests -->
            <h2 class="section-title">My Contests</h2>
            <div id="myContestsListEl" class="placeholder-glow">
                <!-- Placeholder Contest Card -->
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6"
                        style="height: 18px;"></span> <span class="placeholder col-12 mt-2"
                        style="height: 24px;"></span> <span class="placeholder col-10 mt-2"
                        style="height: 16px;"></span>
                    <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> </div>
                </div>
                <p id="noContestsMessageEl" class="text-secondary text-center" style="display: none;">You haven't
                    joined any contests yet.</p>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs"> <button class="tab-item active" data-status="upcoming"><i
                        class="bi bi-calendar-event-fill"></i> Upcoming</button> <button class="tab-item"
                    data-status="ongoing"><i class="bi bi-play-circle-fill"></i> Ongoing</button> <button
                    class="tab-item" data-status="completed"><i class="bi bi-trophy-fill"></i> Results</button> </div>
            <div id="tournamentsListContainerEl" class="mt-3 placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6"
                        style="height: 18px;"></span> <span class="placeholder col-12 mt-2"
                        style="height: 24px;"></span> <span class="placeholder col-10 mt-2"
                        style="height: 16px;"></span>
                    <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> </div>
                </div>
            </div>
            <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No tournaments
                found.</p>
        </section>

        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
            <div class="wallet-card custom-card">
                <h2 class="section-title mb-4">Wallet</h2>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Total Balance</span> <span
                        class="balance-item-value" id="walletTotalBalanceEl"><span class="placeholder col-3"></span></span>
                    <div class="balance-item-action"> <button class="btn-custom-link" id="allTransactionsBtnEl">History
                            <i class="bi bi-chevron-right"></i></button> </div>
                </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Winning Cash</span> <span
                        class="balance-item-value" id="walletWinningCashEl"><span class="placeholder col-3"></span></span>
                    <div class="balance-item-action"> <button class="btn-withdraw"
                            id="withdrawBtnEl">Withdraw</button> </div>
                </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Bonus Cash</span> <span
                        class="balance-item-value" id="walletBonusCashEl"><span class="placeholder col-3"></span></span>
                    <div class="balance-item-action" style="min-width: 100px;"></div>
                </div>
                <button class="btn btn-custom btn-custom-secondary w-100 mt-4" id="addAmountWalletBtnEl"> <i
                        class="bi bi-plus-circle-fill me-2"></i>Add Amount </button>
            </div>
            <h3 class="section-title mt-4">Recent Transactions</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow">
                <div class="custom-card p-2 mb-2 placeholder-glow">
                    <div class="d-flex justify-content-between"> <span class="placeholder col-5"
                            style="height: 16px;"></span> <span class="placeholder col-3"
                            style="height: 16px;"></span> </div>
                    <div class="small text-secondary mt-1"><span class="placeholder col-6"
                            style="height: 14px;"></span></div>
                </div>
                <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading
                    transactions...</p>
            </div>
        </section>

        <!-- Earnings Section -->
        <section id="earnings-section" class="section">
            <h2 class="section-title">Earnings</h2>
            <div class="custom-card text-center">
                <i class="bi bi-coin display-4 text-accent mb-3"></i>
                <p class="text-secondary mb-4">Track your earnings from tournaments and referrals here.</p>
                <div class="placeholder-glow">
                    <p>Total Earned: <strong id="earningsTotalEl"><span class="placeholder col-3"></span></strong></p>
                    <p>From Referrals: <strong id="earningsReferralEl"><span class="placeholder col-3"></span></strong></p>
                </div>
                <button class="btn btn-custom btn-custom-link mt-3" id="viewEarningsHistoryBtn">View History</button>
            </div>
        </section>

        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="profile-header-card placeholder-glow"> <img src="https://via.placeholder.com/70" alt="Avatar"
                    class="profile-avatar" id="profileAvatarEl">
                <h3 class="profile-name mt-2" id="profileNameEl"><span class="placeholder col-6"></span></h3>
                <p class="profile-email" id="profileEmailEl"><span class="placeholder col-8"></span></p>
                <div class="profile-stats w-100">
                    <div class="stat-item"><strong id="profileTotalMatchesEl"><span
                                class="placeholder col-4"></span></strong><span>Matches Played</span></div>
                    <div class="stat-item"><strong id="profileWonMatchesEl"><span
                                class="placeholder col-4"></span></strong><span>Matches Won</span></div>
                    <div class="stat-item"><strong id="profileTotalEarningsEl"><span
                                class="placeholder col-4"></span></strong><span>Total Winnings</span></div>
                </div>
            </div>
            <div class="profile-links">
                <div class="list-group custom-card">
                    <label
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                        <span><i class="bi bi-bell-fill"></i> Notifications</span>
                        <div class="form-check form-switch"> <input class="form-check-input" type="checkbox"
                                role="switch" id="notificationSwitchEl" checked> </div>
                    </label>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="refer"> <span><i class="bi bi-person-plus-fill"></i> Refer & Earn</span> <i
                            class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="privacy"> <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="terms"> <span><i class="bi bi-file-text-fill"></i> Terms and Conditions</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="refund"> <span><i class="bi bi-arrow-repeat"></i> Refund and Cancellation</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="fairPlay"> <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <button
                        class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item"
                        id="logoutProfileBtnEl"> <span><i class="bi bi-box-arrow-right"></i> Logout</span><span></span>
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- ADDED: Notification List Modal -->
    <div class="modal fade" id="notificationListModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationListModalTitleEl"><i class="bi bi-bell me-2"></i> Notifications</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="notificationListBodyEl" class="list-group">
                        <!-- Notifications will be loaded here -->
                        <div class="text-center p-5 text-secondary">Loading notifications...</div>
                    </div>
                    <div id="notificationListStatusEl" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- END ADDED: Notification List Modal -->

    <!-- Modals -->
    <div class="modal fade" id="policyModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addAmountModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-wallet-fill me-2"></i> How to Add Amount?</h5><button
                        type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>To add amount, pay via UPI/PhonePe to:</p>
                    <p class="text-center text-warning"><strong>UPI ID/Number:</strong> <span
                            class="phonepe-number">[!!! YOUR UPI ID/NUMBER HERE !!!]</span></p>
                    <p class="mt-3 small"><strong><i class="bi bi-exclamation-triangle-fill text-warning"></i>
                            IMPORTANT:</strong> After payment, contact admin via [!!! ADMIN CONTACT INFO HERE !!!] with
                        registered Email (<strong id="modalUserEmailEl">...</strong>) & payment screenshot. Amount added
                        manually after verification.</p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Got it</button></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="withdrawModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-secondary">Withdrawable balance: <strong class="text-light"
                            id="withdrawModalBalanceEl">₹0.00</strong></p>
                    <div class="mb-3"><label for="withdrawAmountInputEl" class="form-label">Amount (Min ₹<span
                                id="minWithdrawAmountEl">50</span>)</label><input type="number" class="form-control"
                            id="withdrawAmountInputEl" placeholder="Enter amount"></div>
                    <div class="mb-3"><label for="withdrawMethodInputEl" class="form-label">Withdrawal Method
                            (UPI/Bank)</label><input type="text" class="form-control" id="withdrawMethodInputEl"
                            placeholder="Enter UPI ID / Bank Details"></div>
                    <div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Cancel</button><button type="button"
                        class="btn btn-custom btn-custom-primary" id="submitWithdrawRequestBtnEl">Submit
                        Request</button></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="matchDetailsModalBodyEl"></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Room ID & Password</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="small text-secondary">ID/Pass shown shortly before match start.</p>
                    <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                        <p class="mb-1">Room ID:</p>
                        <h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span
                                class="placeholder col-6"></span></h4><button
                            class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl"
                            title="Copy Room ID"><i class="bi bi-clipboard"></i></button>
                    </div>
                    <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                        <p class="mb-1">Password:</p>
                        <h4 id="roomPasswordDisplayEl"
                            class="text-accent referral-code placeholder-glow d-inline-block"><span
                                class="placeholder col-6"></span></h4><button
                            class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl"
                            title="Copy Password"><i class="bi bi-clipboard"></i></button>
                    </div>
                    <p class="small text-warning"><i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- New Modal: Collect Join Details (In-Game Name/ID) -->
    <div class="modal fade" id="joinDetailsModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-circle me-2"></i> Enter Details to Join</h5><button
                        type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-secondary mb-3">You are joining: <strong class="text-info"
                            id="modalTournamentName"></strong> for <strong class="text-warning"
                            id="modalEntryFee">₹0</strong>.</p>
                    <form id="joinDetailsForm">
                        <input type="hidden" id="joinDetailsTournamentId">
                        <div class="mb-3">
                            <label for="joinDetailsInGameNameInputEl" class="form-label">In-Game Name/ID</label>
                            <input type="text" class="form-control" id="joinDetailsInGameNameInputEl"
                                placeholder="Your In-Game Name or ID" required maxlength="30">
                            <small class="text-danger d-block mt-2" id="joinDetailsStatusMessage"
                                style="display: none;"></small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-accent"
                        id="submitJoinDetailsBtnEl">Confirm Join</button>
                </div>
            </div>
        </div>
    </div>
    <!-- End New Modal -->

    <!-- New Notification Toast/Banner -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Operation completed successfully!</span>
    </div>


    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item" data-section="home-section"><i
                class="bi bi-house-door-fill"></i><span>Home</span></button>
        <button class="nav-item" data-section="wallet-section"><i
                class="bi bi-wallet-fill"></i><span>Wallet</span></button>
        <button class="nav-item" data-section="earnings-section"><i
                class="bi bi-coin"></i><span>Earnings</span></button>
        <button class="nav-item" data-section="profile-section"><i
                class="bi bi-person-fill"></i><span>Profile</span></button>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Firebase SDK & App Logic (RESTRUCTURED) -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, runTransaction, off, limitToLast, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // ===============================================================
        // ================= !!! IMPORTANT !!! ===========================
        // Replace the placeholder values below with your actual Firebase project configuration.
        // You can find these details in your Firebase project settings:
        // Project settings > General > Your apps > Web app > SDK setup and configuration > Config
        // ===============================================================
        const firebaseConfig = {
  apiKey: "AIzaSyBN9ejzxZT6RuBz_bwjRCHlsd20rYDVT-o",
  authDomain: "games-9f30e.firebaseapp.com",
  databaseURL: "https://games-9f30e-default-rtdb.firebaseio.com",
  projectId: "games-9f30e",
  storageBucket: "games-9f30e.firebasestorage.app",
  messagingSenderId: "431473992521",
  appId: "1:431473992521:web:17e77fce9b9d2825f33098",
  measurementId: "G-G92XLDKH31"
};
        // ===============================================================
        // ===============================================================

        // Initialize Firebase
        let app, db, auth;
        try {
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                console.warn("Firebase config using placeholder values. Replace them with your actual project details.");
            }
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase Initialized (check config if using placeholders)");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            // Don't halt execution, let the catch block in DOMContentLoaded handle the UI alert
        }

        // --- DOM Elements Cache ---
         const getElement = (id) => document.getElementById(id);
         const querySel = (selector) => document.querySelector(selector);
         const querySelAll = (selector) => document.querySelectorAll(selector);
         const elements = {
             sections: querySelAll('.section'), bottomNavItems: querySelAll('.bottom-nav .nav-item'), globalLoader: getElement('globalLoaderEl'),
             headerBackBtn: getElement('headerBackBtnEl'), headerTitleContainer: getElement('headerTitleContainerEl'), headerGameTitle: getElement('headerGameTitleEl'), headerWalletChip: getElement('headerWalletChipEl'), headerChipBalance: getElement('headerChipBalanceEl'), headerUserGreeting: getElement('headerUserGreetingEl'), appLogo: getElement('appLogoEl'), notificationBtn: getElement('notificationBtnEl'), notificationBadge: querySel('.notification-badge'),
             loginSection: getElement('login-section'),
             // Login Form Elements (Mapped IDs)
             emailLoginForm: getElement('emailLoginForm'),
             loginEmailInput: getElement('loginEmailInputEl'),
             loginPasswordInput: getElement('loginPasswordInputEl'), 
             loginEmailBtn: getElement('loginEmailBtnEl'),
             loginStatusMessage: getElement('loginStatusMessageEl'),
             forgotPasswordLink: getElement('forgotPasswordLinkEl'),
             // Signup Form Elements (Mapped IDs)
             emailSignupForm: getElement('emailSignupForm'),
             signupEmailInput: getElement('signupEmailInputEl'),
             signupPasswordInput: getElement('signupPasswordInputEl'),
             signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'), 
             signupReferralCodeInput: getElement('signupReferralCodeInputEl'), 
             signupEmailBtn: getElement('signupEmailBtnEl'),
             signupStatusMessage: getElement('signupStatusMessageEl'),
             // NEW LOGIN UI ELEMENTS
             lampTongue: querySel('#lampToggle .lamp_tongue'),
             lightBeam: querySel('#lampToggle .light-beam'),
             lampToggle: getElement('lampToggle'),
             modeBtns: querySelAll('.mode-btn'),
             activeSlider: querySel('.active-slider'),
             notification: getElement('notification'),
             notificationText: getElement('notificationText'),
             newPasswordInput: getElement('signupPasswordInputEl'), 
             passwordStrength: getElement('passwordStrength'),
             strengthText: getElement('strengthText'),
             toggleLoginPassword: getElement('toggleLoginPassword'),
             toggleNewPassword: getElement('toggleNewPassword'),
             toggleConfirmPassword: getElement('toggleConfirmPassword'),
             // Removed redundant aliases for password inputs (FIXED PREVIOUSLY)
             
             homeSection: getElement('home-section'), promotionSlider: getElement('promotionSliderEl'), gamesList: getElement('gamesListEl'), myContestsList: getElement('myContestsListEl'), noContestsMessage: getElement('noContestsMessageEl'),
             tournamentsSection: getElement('tournaments-section'), tournamentsListContainer: getElement('tournamentsListContainerEl'), noTournamentsMessage: getElement('noTournamentsMessageEl'), tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
             walletSection: getElement('wallet-section'), walletTotalBalance: getElement('walletTotalBalanceEl'), walletWinningCash: getElement('walletWinningCashEl'), walletBonusCash: getElement('walletBonusCashEl'), allTransactionsBtn: getElement('allTransactionsBtnEl'), withdrawBtn: getElement('withdrawBtnEl'), addAmountWalletBtn: getElement('addAmountWalletBtnEl'), recentTransactionsList: getElement('recentTransactionsListEl'), noTransactionsMessage: getElement('noTransactionsMessageEl'),
             earningsSection: getElement('earnings-section'), earningsTotal: getElement('earningsTotalEl'), earningsReferral: getElement('earningsReferralEl'), viewEarningsHistoryBtn: getElement('viewEarningsHistoryBtn'),
             profileSection: getElement('profile-section'), profileAvatar: getElement('profileAvatarEl'), profileName: getElement('profileNameEl'), profileEmail: getElement('profileEmailEl'), profileTotalMatches: getElement('profileTotalMatchesEl'), profileWonMatches: getElement('profileWonMatchesEl'), profileTotalEarnings: getElement('profileTotalEarningsEl'), logoutProfileBtn: getElement('logoutProfileBtnEl'), policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'), notificationSwitch: getElement('notificationSwitchEl'),
             // ADDED NOTIFICATION ELEMENTS
             notificationListModalInstance: getElement('notificationListModalEl') ? new bootstrap.Modal(getElement('notificationListModalEl')) : null,
             notificationListModalTitle: getElement('notificationListModalTitleEl'),
             notificationListBody: getElement('notificationListBodyEl'),
             notificationListStatus: getElement('notificationListStatusEl'),
             
             policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, policyModalTitle: getElement('policyModalTitleEl'), policyModalBody: getElement('policyModalBodyEl'),
             addAmountModalInstance: getElement('addAmountModalEl') ? new bootstrap.Modal(getElement('addAmountModalEl')) : null, modalUserEmail: getElement('modalUserEmailEl'),
             withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null, withdrawModalBalance: getElement('withdrawModalBalanceEl'), withdrawAmountInput: getElement('withdrawAmountInputEl'), withdrawMethodInput: getElement('withdrawMethodInputEl'), minWithdrawAmount: getElement('minWithdrawAmountEl'), withdrawStatusMessage: getElement('withdrawStatusMessageEl'), submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
             matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null, matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'), matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
             idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, roomIdDisplay: getElement('roomIdDisplayEl'), roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
             joinDetailsModalInstance: getElement('joinDetailsModalEl') ? new bootstrap.Modal(getElement('joinDetailsModalEl')) : null,
             modalTournamentName: getElement('modalTournamentName'),
             modalEntryFee: getElement('modalEntryFee'),
             joinDetailsTournamentId: getElement('joinDetailsTournamentId'),
             joinDetailsInGameNameInput: getElement('joinDetailsInGameNameInputEl'),
             joinDetailsStatusMessage: getElement('joinDetailsStatusMessage'),
             submitJoinDetailsBtn: getElement('submitJoinDetailsBtnEl'),
             securityWarning: getElement('securityWarning')
         };

        // --- App State ---
        let currentUser = null; 
        let userProfile = {}; 
        let currentSectionId = 'login-section'; 
        let dbListeners = {};
        let swiperInstance; 
        let currentTournamentGameId = null; 
        let appSettings = {};
        let validReferrerUid = null; 
        let unreadNotificationCount = 0; // State for badge

        
        // --- NEW LAMP/ANIMATION/NOTIFICATION STATE ---
        let isLampOn = false;
        let lampTimeout = null;
        
        // --- Core Utility Functions (Moved to top) ---
        const showLoader = (show) => { if (elements.globalLoader) elements.globalLoader.style.display = show ? 'flex' : 'none'; };
        function copyToClipboard(targetSelector) { 
             if (!targetSelector) { showNotification('Copy target not defined.', 'error'); return; }
             const targetElement = querySel(targetSelector);
             if (!targetElement) { showNotification('Element to copy from not found.', 'error'); return; }
             const textToCopy = targetElement.textContent;
             if (!textToCopy || textToCopy === 'N/A' || textToCopy.includes('placeholder')) { showNotification('Nothing to copy.', 'warning'); return; }
             navigator.clipboard.writeText(textToCopy).then(() => showNotification('Copied to clipboard!', 'success')).catch(err => { console.error('Failed to copy:', err); showNotification('Failed to copy.', 'error'); });
        }
        function shareReferral(code) { if (!navigator.share) { showNotification('Web Share not supported. Copy the code manually.', 'warning'); return; } if (!code || code === 'N/A') { showNotification('Referral code not available.', 'warning'); return; } navigator.share({ title: 'Join Me on Gaming Tournament!', text: `Join using my referral code: ${code} & get rewards! App: ${window.location.origin}`, url: window.location.origin }).catch((error) => console.log('Error sharing', error)); }
        function generateReferralCode(length = 8) { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); return result; }
        function getTimeRemaining(startTime) { if (!startTime) return 'TBA'; const now = Date.now(); const diff = startTime - now; if (diff <= 0) return 'Starting Soon'; const days = Math.floor(diff / 86400000); const hours = Math.floor((diff % 86400000) / 3600000); const minutes = Math.floor((diff % 3600000) / 60000); let o = ''; if (days > 0) o += `${days}d `; if (hours > 0 || days > 0) o += `${hours}h `; o += `${minutes}m`; return o.trim() || 'Now'; }
        const removePlaceholders = (parentElement) => { if (!parentElement) return; parentElement.classList.remove('placeholder-glow'); parentElement.querySelectorAll('.placeholder').forEach(el => el.remove()); };
        
        // --- NEW: Lamp Functions ---
        function turnLampOn() {
            if (!elements.lampTongue || !elements.lightBeam) return;
            if (!isLampOn) {
                elements.lampTongue.style.opacity = '1';
                elements.lightBeam.style.height = '100px';
                isLampOn = true;
            }
        }
        function turnLampOff() {
            if (!elements.lampTongue || !elements.lightBeam) return;
            if (isLampOn) {
                elements.lampTongue.style.opacity = '0';
                elements.lightBeam.style.height = '0';
                isLampOn = false;
            }
        }
        function glowLamp() {
            turnLampOn();
            if (lampTimeout) clearTimeout(lampTimeout);
            lampTimeout = setTimeout(() => {
                turnLampOff();
            }, 2000);
        }
        function successGlow() {
            turnLampOn();
            if(elements.lightBeam) elements.lightBeam.style.background = 'radial-gradient(ellipse at center, rgba(76, 175, 80, 0.4) 0%, transparent 70%)'; 
            if (lampTimeout) clearTimeout(lampTimeout);
            lampTimeout = setTimeout(() => {
                turnLampOff();
                if(elements.lightBeam) elements.lightBeam.style.background = 'radial-gradient(ellipse at center, rgba(255, 204, 0, 0.4) 0%, transparent 70%)'; 
            }, 2000);
        }
        
        // --- NEW: Notification Function ---
        function showNotification(message, type) {
            if (!elements.notification || !elements.notificationText) return;
            elements.notificationText.textContent = message;
            const notificationType = type === 'success' ? 'success' : (type === 'warning' || type === 'info' ? 'info' : 'error');
            const iconClass = type === 'success' ? 'fas fa-check-circle' : (type === 'warning' || type === 'info' ? 'fas fa-info-circle' : 'fas fa-times-circle'); 
            elements.notification.className = 'notification ' + notificationType;
            elements.notification.querySelector('i').className = iconClass;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 3000);
        }
        
        // --- MODIFIED: showStatusMessage (Integrates with new Notification system) ---
        function showStatusMessage(element, message, type = 'danger', autohide = true) { 
            // 1. Show message in the original (visually hidden by new design) status element for debugging/Firebase pattern
            if (!element) return; 
            element.innerHTML = message; 
            element.className = `alert alert-${type} mt-3`; 
            element.style.display = 'block'; 
            element.setAttribute('role', 'alert');
            
            // 2. Show the fancy notification
            showNotification(message, type);
            
            // 3. Trigger lamp animation
            if (type === 'success') {
                successGlow();
            } else {
                glowLamp();
            }
            
            // 4. Hide the Bootstrap status element after a delay
            if (autohide) { 
                setTimeout(() => { 
                    if (element.innerHTML === message) element.style.display = 'none'; 
                }, 5000); 
            }
        }
        function clearStatusMessage(element) { 
            if (!element) return; 
            element.style.display = 'none'; 
            element.innerHTML = ''; 
            element.removeAttribute('role'); 
        }

        // --- NEW: Password Strength Check Functions ---
        function checkPasswordStrength(password) {
            let strength = 0;
            let text = 'Very Weak';
            let color = '#f44336';
            
            if (password.length >= 6) strength++; 
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++; 
            
            if (strength === 1) { text = 'Weak'; color = '#ff9800'; } 
            else if (strength === 2) { text = 'Fair'; color = '#ffc107'; } 
            else if (strength === 3) { text = 'Good'; color = '#8bc34a'; } 
            else if (strength >= 4) { text = 'Strong'; color = '#4CAF50'; }
            
            return { strength, text, color };
        }
        function updatePasswordStrength() {
            if (!elements.newPasswordInput || !elements.passwordStrength || !elements.strengthText) return;
            const password = elements.newPasswordInput.value;
            const { strength, text, color } = checkPasswordStrength(password);
            
            let width = 0;
            if (strength === 1) { width = 25; } 
            else if (strength === 2) { width = 50; } 
            else if (strength === 3) { width = 75; } 
            else if (strength >= 4) { width = 100; }
            
            elements.passwordStrength.style.width = width + '%';
            elements.passwordStrength.style.background = color;
            elements.strengthText.textContent = text;
            elements.strengthText.style.color = color;
        }
        
        // --- NEW: Toggle Password Visibility Function ---
        function togglePasswordVisibility(inputElement, toggleElement) {
            if (!inputElement || !toggleElement) return;
            const icon = toggleElement.querySelector('i');
            const isPassword = inputElement.type === 'password';
            
            inputElement.type = isPassword ? 'text' : 'password';
            icon.className = isPassword ? 'fas fa-eye-slash' : 'fas fa-eye';
            glowLamp();
        }

        // --- UI Functions ---
         function showSection(sectionId) {
             if (!auth || !sectionId || !elements.sections) { console.error("Cannot show section", sectionId); return; }
             const targetSection = getElement(sectionId); if (!targetSection) { console.error(`Section element "${sectionId}" not found.`); showSection(currentUser ? 'home-section' : 'login-section'); return; }
             const protectedSections = ['home-section', 'wallet-section', 'earnings-section', 'profile-section', 'tournaments-section'];
             const isLoggedIn = !!currentUser;
             if (protectedSections.includes(sectionId) && !isLoggedIn) { showSection('login-section'); return; }
             if (sectionId === 'login-section' && isLoggedIn) { showSection('home-section'); return; }
             
             // FIX: Toggle body class to hide fixed header/footer and center content (From previous iteration)
             const isLogin = sectionId === 'login-section';
             document.body.classList.toggle('login-active', isLogin); 
             
             elements.sections.forEach(sec => sec.classList.remove('active')); targetSection.classList.add('active'); currentSectionId = sectionId;
             updateHeaderForSection(sectionId);
             elements.bottomNavItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
             if (sectionId === 'login-section') { 
                toggleLoginForm(true); 
             } else {
                 // FIX: Explicitly call data loading functions on navigation for all sections
                 if (sectionId === 'home-section') loadHomePageData();
                 else if (sectionId === 'wallet-section') loadWalletData();
                 else if (sectionId === 'earnings-section') loadEarningsData();
                 else if (sectionId === 'profile-section') loadProfileData();
             }
             window.scrollTo(0, 0);
         }
         function updateHeaderForSection(sectionId) {
             const showBackButton = (sectionId === 'tournaments-section'); const defaultTitleVisible = !showBackButton; const gameTitleVisible = showBackButton;
             if (elements.headerBackBtn) elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none';
             if (elements.headerTitleContainer) elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none';
             if (elements.headerGameTitle) elements.headerGameTitle.style.display = gameTitleVisible ? 'block' : 'none';
             if (gameTitleVisible && currentTournamentGameId && elements.headerGameTitle) {
                 const gameName = appSettings?.games?.[currentTournamentGameId]?.name || `Game`;
                 elements.headerGameTitle.textContent = gameName;
              }
             else if (defaultTitleVisible && elements.headerUserGreeting) { const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest'; elements.headerUserGreeting.textContent = nameToShow; }
         }
         function updateGlobalUI(isLoggedIn) {
             if (elements.headerWalletChip) { elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section'); else elements.headerWalletChip.onclick = null; }
             if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest';
             if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0';
             elements.bottomNavItems.forEach(item => { const section = item.dataset.section; item.style.display = (section === 'home-section' || isLoggedIn) ? 'flex' : 'none'; });
         }
         function populateUserInfo(user, profile) {
             if (!user || !profile) return;
             const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User';
             const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=70`;
             const balance = (profile.balance || 0); const winningCash = (profile.winningCash || 0); const bonusCash = (profile.bonusCash || 0);
             const totalEarnings = (profile.totalEarnings || 0); const referralEarnings = (profile.referralEarnings || 0);
             const totalMatches = profile.totalMatches || 0; const wonMatches = profile.wonMatches || 0;
             const formatCurrency = (amount) => `₹${amount.toFixed(2)}`;
             // FIX: The user greeting was showing 'Welcomed' because the user object (if only email/uid auth was used) had a null display name.
             // This code ensures a non-null display name is always used, but the main issue was likely the data loading being incomplete (fixed elsewhere).
             if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0]; 
             if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(balance);
             if (elements.walletTotalBalance) { elements.walletTotalBalance.textContent = formatCurrency(balance); removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow')); }
             if (elements.walletWinningCash) { elements.walletWinningCash.textContent = formatCurrency(winningCash); removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow')); }
             if (elements.walletBonusCash) { elements.walletBonusCash.textContent = formatCurrency(bonusCash); removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow')); }
             if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = formatCurrency(winningCash);
             if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
             if (elements.profileName) { elements.profileName.textContent = displayName; removePlaceholders(elements.profileName.closest('.placeholder-glow')); }
             if (elements.profileEmail) { elements.profileEmail.textContent = user.email || 'N/A'; removePlaceholders(elements.profileEmail.closest('.placeholder-glow')); }
             if (elements.profileTotalMatches) { elements.profileTotalMatches.textContent = totalMatches; removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow')); }
             if (elements.profileWonMatches) { elements.profileWonMatches.textContent = wonMatches; removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow')); }
             if (elements.profileTotalEarnings) { elements.profileTotalEarnings.textContent = formatCurrency(totalEarnings); removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow')); }
             if (elements.earningsTotal) { elements.earningsTotal.textContent = formatCurrency(totalEarnings); removePlaceholders(elements.earningsTotal.closest('.placeholder-glow')); }
             if (elements.earningsReferral) { elements.earningsReferral.textContent = formatCurrency(referralEarnings); removePlaceholders(elements.earningsReferral.closest('.placeholder-glow')); }
             if (elements.modalUserEmail) elements.modalUserEmail.textContent = user.email || 'N/A';
         }
        function toggleLoginForm(showLogin) {
            if (!elements.emailLoginForm || !elements.emailSignupForm || !elements.activeSlider || !elements.modeBtns) return;
            
            clearStatusMessage(elements.loginStatusMessage);
            clearStatusMessage(elements.signupStatusMessage);
            
            const loginModeBtn = querySel('.mode-btn[data-mode="login"]');
            const signupModeBtn = querySel('.mode-btn[data-mode="signup"]');

            if (showLogin) {
                elements.emailLoginForm.classList.add('active');
                elements.emailSignupForm.classList.remove('active');
                if(elements.activeSlider && loginModeBtn && signupModeBtn) {
                     elements.activeSlider.classList.remove('signup');
                     loginModeBtn.classList.add('active');
                     signupModeBtn.classList.remove('active');
                }
                elements.emailLoginForm.reset();
                elements.emailSignupForm.reset();
            } else {
                elements.emailLoginForm.classList.remove('active');
                elements.emailSignupForm.classList.add('active');
                if(elements.activeSlider && loginModeBtn && signupModeBtn) {
                    elements.activeSlider.classList.add('signup');
                    signupModeBtn.classList.add('active');
                    loginModeBtn.classList.remove('active');
                }
                elements.emailLoginForm.reset();
                elements.emailSignupForm.reset();
                if (elements.newPasswordInput) elements.newPasswordInput.value = '';
                updatePasswordStrength();
            }
            glowLamp();
        }

        // --- Firebase Auth Functions ---
         async function signUpWithEmail() {
             if (!auth || elements.signupEmailBtn.disabled) return;
             
             const em = elements.signupEmailInput.value.trim();
             const pw = elements.signupPasswordInput.value;
             const cpw = elements.signupConfirmPasswordInput.value;
             const refCode = elements.signupReferralCodeInput.value.trim();

             if (!em || !pw || !cpw) { 
                 showStatusMessage(elements.signupStatusMessage, 'Fill required fields.', 'warning'); 
                 return; 
             }
             if (pw !== cpw) { 
                 showStatusMessage(elements.signupStatusMessage, 'Passwords don\'t match.', 'warning'); 
                 return; 
             }
             if (pw.length < 6) { 
                 showStatusMessage(elements.signupStatusMessage, 'Password min 6 chars.', 'warning'); 
                 return; 
             }

             elements.signupEmailBtn.disabled = true;
             elements.signupEmailBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Signing Up...';
             showLoader(true); 
             clearStatusMessage(elements.signupStatusMessage);
             validReferrerUid = null; 

             try {
                 if (refCode) {
                     console.log("Validating referral code:", refCode);
                     const usersRef = ref(db, 'users');
                     const q = query(usersRef, orderByChild('referralCode'), equalTo(refCode));
                     const snapshot = await get(q);
                     if (snapshot.exists()) {
                         const referrerData = snapshot.val();
                         const referrerId = Object.keys(referrerData)[0]; 
                         const referrerProfile = referrerData[referrerId];
                         if (referrerId && referrerProfile.email) { 
                             validReferrerUid = referrerId;
                             console.log("Valid referrer found:", validReferrerUid);
                         } else {
                             console.warn("Referral code found, but referrer data invalid:", referrerData);
                         }
                     } else {
                         console.log("Referral code not found:", refCode);
                     }
                 }

                 await createUserWithEmailAndPassword(auth, em, pw);
                 
                 showNotification('Sign up successful! Logging in...', 'success'); 
                 elements.signupEmailBtn.innerHTML = '<i class="fas fa-check"></i> Success!'; 

             } catch (e) {
                 console.error("Signup Error:", e); 
                 let m = `Signup failed.`; 
                 switch (e.code) { 
                     case 'auth/email-already-in-use': m = 'Email already registered.'; break; 
                     case 'auth/weak-password': m = 'Password too weak.'; break; 
                     case 'auth/invalid-email': m = 'Invalid email.'; break; 
                     case 'auth/network-request-failed': m = 'Network error.'; break; 
                     default: m = `Error: ${e.message}`; 
                 } 
                 showStatusMessage(elements.signupStatusMessage, m, 'danger');
                 elements.signupEmailBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account'; 
             } finally {
                 showLoader(false);
                 elements.signupEmailBtn.disabled = false;
             }
         }
         async function loginWithEmail() {
             if (!auth || elements.loginEmailBtn.disabled) return;
             
             const em = elements.loginEmailInput.value.trim();
             const pw = elements.loginPasswordInput.value;
             if (!em || !pw) { 
                 showStatusMessage(elements.loginStatusMessage, 'Enter email & password.', 'warning'); 
                 return; 
             }
             
             elements.loginEmailBtn.disabled = true;
             elements.loginEmailBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Logging In...';
             showLoader(true); 
             clearStatusMessage(elements.loginStatusMessage);
             
             try { 
                 await signInWithEmailAndPassword(auth, em, pw); 
                 showNotification('Login successful! Welcome back.', 'success'); 
                 elements.loginEmailBtn.innerHTML = '<i class="fas fa-check"></i> Success!'; 
             }
             catch (e) { 
                 console.error("Login Error:", e); 
                 let m = `Login failed.`; 
                 switch (e.code) { 
                     case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': m = 'Invalid email or password.'; break; 
                     case 'auth/invalid-email': m = 'Invalid email format.'; break; 
                     case 'auth/too-many-requests': m = 'Too many attempts. Reset pass or wait.'; break; 
                     case 'auth/network-request-failed': m = 'Network error.'; break; 
                     case 'auth/user-disabled': m = 'Account disabled.'; break; 
                     default: m = `Error: ${e.message}`; 
                 } 
                 showStatusMessage(elements.loginStatusMessage, m, 'danger');
                 elements.loginEmailBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login'; 
             }
             finally { 
                 showLoader(false); 
                 elements.loginEmailBtn.disabled = false; 
             }
         }
         async function resetPassword() {
             if (!auth) return;
             const em = elements.loginEmailInput.value.trim();
             if (!em) { 
                 showStatusMessage(elements.loginStatusMessage, 'Enter email for password reset in the field above.', 'warning'); 
                 return; 
             }
             showLoader(true); 
             clearStatusMessage(elements.loginStatusMessage);
             
             try { 
                 await sendPasswordResetEmail(auth, em); 
                 showStatusMessage(elements.loginStatusMessage, 'Password reset email sent! Check inbox/spam.', 'success', false); 
             }
             catch (e) { 
                 console.error("Reset Pass Error:", e); 
                 let m = `Failed to send email.`; 
                 switch (e.code) { 
                     case 'auth/user-not-found': case 'auth/invalid-email': m = 'Email not found.'; break; 
                     case 'auth/network-request-failed': m = 'Network error.'; break; 
                     default: m = `Error: ${e.message}`; 
                 } 
                 showStatusMessage(elements.loginStatusMessage, m, 'danger'); 
             }
             finally { showLoader(false); }
         }
         async function logoutUser() { 
             if (!auth) return; 
             try { 
                 showLoader(true); 
                 await signOut(auth); 
                 showNotification('Logged out successfully.', 'success'); 
             } catch (e) { 
                 console.error("Sign Out Error:", e); 
                 showNotification(`Logout failed: ${e.message}`, 'error'); 
                 showLoader(false); 
             } 
         }

        // --- Auth State Change Handler --- 
         async function handleAuthStateChange(user) {
             if (!auth || !db) { console.error("Firebase not ready in auth change"); showLoader(false); return; }
             showLoader(true); detachAllDbListeners(); currentUser = user;
             const localReferrerUid = validReferrerUid; 
             validReferrerUid = null; 

             if (user) { 
                 console.log("Auth State: Logged In", user.uid); const userRef = ref(db, 'users/' + user.uid);
                 try {
                     const snapshot = await get(userRef);
                     if (snapshot.exists()) { 
                         userProfile = snapshot.val(); const updates = {};
                         if (user.displayName && (!userProfile.displayName || userProfile.displayName !== user.displayName)) updates.displayName = user.displayName;
                         if (user.email && !userProfile.email) updates.email = user.email;
                         if (Object.keys(updates).length > 0) { await update(userRef, updates); userProfile = { ...userProfile, ...updates }; }
                     } else { 
                         console.log("New user, creating profile...");
                         const newUserProfile = {
                             uid: user.uid, displayName: user.displayName || user.email?.split('@')[0] || 'User', email: user.email || null, photoURL: user.photoURL || null,
                             balance: appSettings.newUserBalance || 0, winningCash: 0, bonusCash: appSettings.newUserBonus || 0,
                             totalMatches: 0, wonMatches: 0, totalEarnings: 0, referralEarnings: 0, createdAt: Date.now(),
                             referralCode: generateReferralCode(), joinedTournaments: {}, isAdmin: false,
                             // ADDED: lastSeenNotificationsTimestamp to user profile
                             lastSeenNotificationsTimestamp: Date.now(), 
                             ...(localReferrerUid && { referredBy: localReferrerUid })
                         };
                         await set(userRef, newUserProfile);
                         userProfile = newUserProfile;

                         if (newUserProfile.bonusCash > 0) {
                             await recordTransaction(user.uid, 'signup_bonus', newUserProfile.bonusCash, `Welcome Bonus`);
                         }

                         if (localReferrerUid && appSettings.referralBonus > 0) {
                             console.log(`Awarding referral bonus of ${appSettings.referralBonus} to referrer: ${localReferrerUid}`);
                             const referrerRef = ref(db, `users/${localReferrerUid}`);
                             try {
                                 const referrerUpdateResult = await runTransaction(referrerRef, (referrerData) => {
                                     if (referrerData) {
                                         referrerData.balance = (referrerData.balance || 0) + appSettings.referralBonus;
                                         referrerData.bonusCash = (referrerData.bonusCash || 0) + appSettings.referralBonus; 
                                         referrerData.referralEarnings = (referrerData.referralEarnings || 0) + appSettings.referralBonus;
                                     }
                                     return referrerData;
                                 });

                                 if (referrerUpdateResult.committed) {
                                     await recordTransaction(localReferrerUid, 'referral_bonus', appSettings.referralBonus, `Referral Bonus from ${newUserProfile.displayName || newUserProfile.email}`);
                                     console.log("Referrer bonus awarded successfully.");
                                 } else {
                                     console.error("Referrer bonus transaction aborted.");
                                 }
                             } catch (referrerError) {
                                 console.error("Error awarding referrer bonus:", referrerError);
                             }
                         }
                     }
                     populateUserInfo(user, userProfile); setupRealtimeListeners(user.uid); updateGlobalUI(true);
                     const targetSection = (currentSectionId === 'login-section' || !getElement(currentSectionId)) ? 'home-section' : currentSectionId;
                     showSection(targetSection);
                     // FIX: Explicitly call load home page data here for initial load after auth state change
                     if (targetSection === 'home-section') loadHomePageData();

                 } catch (error) { console.error("Profile handling error:", error); showNotification("Error loading profile. Logging out. " + error.message, 'error'); try { await logoutUser(); } catch (logoutErr) {} }
             } else { 
                 console.log("Auth State: Logged Out"); currentUser = null; userProfile = {}; updateGlobalUI(false); showSection('login-section');
             }
             showLoader(false);
        }
        
        // --- Database & Page Load Functions ---
        async function loadAppSettings() {
             console.log("Loading App Settings...");
             if (!auth || !db) throw new Error("Firebase not initialized.");
             try {
                 const settingsRef = ref(db, 'settings');
                 const snapshot = await get(settingsRef);
                 if (snapshot.exists()) {
                      appSettings = snapshot.val() || {};
                      console.log("App Settings Loaded:", appSettings);
                      if (appSettings.logoUrl && elements.appLogo) elements.appLogo.src = appSettings.logoUrl;
                      if (appSettings.minWithdraw && elements.minWithdrawAmount) elements.minWithdrawAmount.textContent = appSettings.minWithdraw;
                      const upiIdEl = document.querySelector('.phonepe-number');
                      if (upiIdEl) upiIdEl.textContent = appSettings.upiDetails || '[!!! YOUR UPI ID/NUMBER HERE !!!]'; 
                      const contactInfoPEl = document.querySelector('.modal-body p strong#modalUserEmailEl')?.closest('p'); 
                      if(contactInfoPEl && appSettings.supportContact) contactInfoPEl.innerHTML = contactInfoPEl.innerHTML.replace('[!!! ADMIN CONTACT INFO HERE !!!]', appSettings.supportContact);
                 } else {
                      console.warn("App Settings node not found in database! Using default/empty settings.");
                      appSettings = {}; 
                 }
             } catch (e) {
                 // FIX: Added specific check for permission denied error and better message
                 if (e.message && e.message.includes('permission_denied')) {
                    console.error("Settings load failed: Permission Denied (Database Rules likely require authentication for /settings node).", e);
                    // Do not throw a fatal error that stops app execution, just log and use empty settings
                 } else {
                    console.error("Settings load failed:", e);
                    throw new Error("Settings load failed: " + e.message); // Re-throw general errors
                 }
             }
        }
        // FIX: Consolidate data loading to ensure consistent state/UI refresh after auth or navigation
        function loadHomePageData() {
             if (!currentUser) { 
                 if(elements.promotionSlider?.querySelector('.swiper-wrapper')) elements.promotionSlider.querySelector('.swiper-wrapper').innerHTML = ''; 
                 if(elements.gamesList) elements.gamesList.innerHTML = ''; 
                 if(elements.myContestsList) elements.myContestsList.innerHTML = '<p class="text-secondary text-center">Login to view contests.</p>'; 
                 return; 
             }
             loadPromotions();
             loadGames();
             loadMyContests();
        }
        async function loadPromotions() {
              if (!elements.promotionSlider) return;
              const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper');
              if (!sliderWrapper) return;
              // Reset placeholders to show loading state again
              sliderWrapper.classList.add('placeholder-glow');
              sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder" style="height: 100%; border-radius: 10px; display: block; width: 100%;"></span></div>`;
              
              const promoRef = ref(db, 'promotions');
              try {
                  const snapshot = await get(promoRef);
                  const promotions = snapshot.val() || {};
                  const activePromotions = Object.values(promotions).filter(p => p.imageUrl); 
                  removePlaceholders(elements.promotionSlider);
                  sliderWrapper.innerHTML = ''; 
                  if (activePromotions.length > 0) {
                      elements.promotionSlider.style.display = 'block';
                      activePromotions.forEach(promo => {
                          const slide = document.createElement('div');
                          slide.className = 'swiper-slide';
                          slide.innerHTML = promo.link ? `<a href="${promo.link}" target="_blank"><img src="${promo.imageUrl}" alt="Promo"></a>` : `<img src="${promo.imageUrl}" alt="Promo">`;
                          sliderWrapper.appendChild(slide);
                      });
                      if (swiperInstance) swiperInstance.destroy(true, true);
                      swiperInstance = new Swiper(elements.promotionSlider, {
                          loop: activePromotions.length > 1,
                          autoplay: { delay: 3500, disableOnInteraction: false },
                          pagination: { el: '.swiper-pagination', clickable: true },
                          slidesPerView: 1
                      });
                  } else {
                      elements.promotionSlider.style.display = 'none';
                  }
              } catch (e) {
                  console.error("Promo load failed:", e);
                  removePlaceholders(elements.promotionSlider);
                  sliderWrapper.innerHTML = '<p class="text-danger text-center small p-3">Could not load promotions.</p>';
                  elements.promotionSlider.style.display = 'block';
              }
        }
        async function loadGames() {
            if (!elements.gamesList) return;
            elements.gamesList.classList.add('placeholder-glow');
            elements.gamesList.innerHTML = `<div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div> <div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div>`;

            const gamesRef = ref(db, 'games');
            try {
                const snapshot = await get(gamesRef);
                const games = snapshot.val() || {};
                 const activeGames = Object.entries(games)
                                        .filter(([, game]) => game.imageUrl && game.name)
                                        .sort(([, gameA], [, gameB]) => (gameA.order || 0) - (gameB.order || 0));
                removePlaceholders(elements.gamesList);
                elements.gamesList.innerHTML = ''; 
                if (activeGames.length > 0) {
                     if (!appSettings.games) appSettings.games = {};
                    activeGames.forEach(([gameId, game]) => {
                         appSettings.games[gameId] = { name: game.name };
                        const col = document.createElement('div');
                        col.className = 'col-6';
                        col.innerHTML = `<div class="game-card custom-card" data-game-id="${gameId}" data-game-name="${game.name}"><img src="${game.imageUrl}" alt="${game.name}"><span>${game.name}</span></div>`;
                        col.querySelector('.game-card').addEventListener('click', () => {
                            currentTournamentGameId = gameId;
                            loadTournamentsForGame(gameId, game.name);
                        });
                        elements.gamesList.appendChild(col);
                    });
                } else {
                    elements.gamesList.innerHTML = '<p class="text-secondary text-center col-12">No games available.</p>';
                }
            } catch (e) {
                console.error("Games load failed:", e);
                removePlaceholders(elements.gamesList);
                elements.gamesList.innerHTML = '<p class="text-danger text-center col-12">Could not load games.</p>';
            }
        }
        function loadTournamentsForGame(gameId, gameName) {
             if (!elements.tournamentsSection) return;
             currentTournamentGameId = gameId;
             elements.tournamentTabs.forEach(t => t.classList.remove('active'));
             querySel('.tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add('active');
             showSection('tournaments-section'); 
             filterTournaments(gameId, 'upcoming');
        }
        async function filterTournaments(gameId, status) {
            if (!elements.tournamentsListContainer) return;
            elements.tournamentsListContainer.innerHTML = ''; 
            elements.tournamentsListContainer.classList.add('placeholder-glow');
            elements.tournamentsListContainer.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>`; 
            elements.noTournamentsMessage.style.display = 'none'; 
            try {
                const tQuery = query(ref(db, 'tournaments'), orderByChild('gameId'), equalTo(gameId));
                const s = await get(tQuery);
                const allT = s.val() || {};
                const fT = Object.entries(allT).filter(([, t]) => t.status === status).sort(([, tA], [, tB]) => (tA.startTime || 0) - (tB.startTime || 0));
                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = ''; 
                if (fT.length > 0) {
                    fT.forEach(([tId, t]) => {
                        const card = createTournamentCardElement(tId, t);
                        elements.tournamentsListContainer.appendChild(card);
                    });
                } else {
                    elements.noTournamentsMessage.style.display = 'block';
                    elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`;
                }
            } catch (e) {
                console.error(`Tournaments filter failed (${status}):`, e);
                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '<p class="text-danger tc mt-4">Could not load tournaments.</p>';
                elements.noTournamentsMessage.style.display = 'none';
            }
        }
        function createTournamentCardElement(tId, t) {
             const card = document.createElement('div'); card.className = 'tournament-card'; card.dataset.tournamentId = tId;
             const eFee = t.entryFee || 0; const pkPrize = t.perKillPrize || 0; const pPool = t.prizePool || 0;
             const sTime = t.startTime ? new Date(t.startTime) : null; const sTimeLoc = sTime ? sTime.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'TBA';
             const regP = t.registeredPlayers || {}; const regC = Object.keys(regP).length; const maxP = t.maxPlayers || 0;
             const spotsL = maxP > 0 ? Math.max(0, maxP - regC) : Infinity; const isF = maxP > 0 && spotsL <= 0;
             const isJ = currentUser && userProfile?.joinedTournaments?.[tId];
             const canJ = !isJ && !isF && t.status === 'upcoming'; let timerTxt = t.status?.toUpperCase() || 'N/A';
             if (t.status === 'upcoming' && sTime) timerTxt = getTimeRemaining(t.startTime); else if (t.status === 'ongoing') timerTxt = 'LIVE'; else if (t.status === 'completed' || t.status === 'result') timerTxt = 'ENDED';
             let spotsTxt = 'Unlimited Spots'; let progP = 0; if (maxP > 0) { spotsTxt = `<span class="${spotsL <= 5 ? 'text-danger' : 'text-accent'}">${spotsL}</span> Spots Left (${regC}/${maxP})`; progP = Math.min(100, (regC / maxP) * 100); }
             let actBtn = ''; let idPassBtn = ''; if (isJ) { actBtn = `<button class="btn btn-custom btn-sm btn-joined" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>`; if (t.status === 'ongoing' || (t.status === 'upcoming' && t.showIdPass && sTime && Date.now() > sTime.getTime() - 900000)) { idPassBtn = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${tId}"><i class="bi bi-key-fill"></i> View ID & Pass</button>`; } } else if (canJ) { actBtn = `<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${tId}" data-fee="${eFee}">₹${eFee} Join <i class="bi bi-arrow-right-short"></i></button>`; } else { let disR = t.status !== 'upcoming' ? t.status?.toUpperCase() : (isF ? 'Full' : 'Closed'); actBtn = `<button class="btn btn-custom btn-sm btn-disabled" disabled>${disR || 'N/A'}</button>`; }
             card.innerHTML = `<div class="tournament-card-header"><div class="tournament-card-tags">${t.mode ? `<span>${t.mode}</span>` : ''}${t.map ? `<span>${t.map}</span>` : ''}${t.tags ? (Array.isArray(t.tags) ? t.tags.map(tag => `<span>${tag}</span>`).join('') : Object.values(t.tags).map(tag => `<span>${tag}</span>`).join('')) : ''}</div><div class="tournament-card-timer">${timerTxt}</div></div><h3 class="tournament-card-title">${t.icon ? `<i class="${t.icon}"></i>` : '<i class="bi bi-joystick text-accent"></i>'} ${t.name || 'Tournament'}</h3><p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${sTimeLoc}</p><div class="tournament-card-info"><div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> ₹${pPool}</strong></div><div class="info-item"><span>Per Kill</span><strong>₹${pkPrize}</strong></div><div class="info-item"><span>Entry Fee</span><strong class="${eFee > 0 ? 'text-info' : ''}">${eFee > 0 ? `₹${eFee}` : 'Free'}</strong></div></div><div class="tournament-card-spots">${spotsTxt}${maxP > 0 ? `<div class="progress mt-1" style="height: 6px;"><div class="progress-bar bg-warning" role="progressbar" style="width: ${progP}%"></div></div>` : ''}</div><div class="tournament-card-actions"><button class="btn btn-custom btn-custom-secondary btn-sm btn-details" data-tournament-id="${tId}">Details</button>${actBtn}</div>${idPassBtn}`;
             const jBtn = card.querySelector('.btn-join'); if (jBtn) jBtn.addEventListener('click', handleJoinTournamentClick);
             const dBtn = card.querySelector('.btn-details'); if (dBtn) dBtn.addEventListener('click', handleMatchDetailsClick);
             const ipBtn = card.querySelector('.btn-idpass'); if (ipBtn) ipBtn.addEventListener('click', handleIdPasswordClick);
             return card;
        }
        async function loadMyContests() {
             if (!currentUser || !elements.myContestsList) { if(elements.myContestsList) removePlaceholders(elements.myContestsList); if(elements.myContestsList) elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; return; }
             const joinedIds = Object.keys(userProfile.joinedTournaments || {});
             elements.myContestsList.classList.add('placeholder-glow');
             elements.myContestsList.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>`; 
             if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'none';
             if (joinedIds.length === 0) { removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; return; }
             try {
                 const contestPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`)));
                 const snapshots = await Promise.all(contestPromises);
                 removePlaceholders(elements.myContestsList);
                 elements.myContestsList.innerHTML = ''; 
                 const contestCards = [];
                 snapshots.forEach((snapshot, index) => {
                     if (snapshot.exists()) {
                         const t = snapshot.val();
                         if (t.status === 'upcoming' || t.status === 'ongoing') {
                             const tId = joinedIds[index];
                             contestCards.push({ startTime: t.startTime || 0, card: createTournamentCardElement(tId, t) });
                         }
                     } else {
                         console.warn(`Joined tournament ${joinedIds[index]} not found in tournaments node.`);
                     }
                 });
                 contestCards.sort((a, b) => a.startTime - b.startTime); 
                 if (contestCards.length > 0) {
                     contestCards.forEach(item => elements.myContestsList.appendChild(item.card));
                 } else if (elements.noContestsMessage) {
                     elements.noContestsMessage.style.display = 'block';
                     elements.noContestsMessage.textContent = "No upcoming/ongoing joined contests.";
                 }
             } catch (e) { console.error("My contests load failed:", e); removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = '<p class="text-danger tc">Could not load contests.</p>'; }
        }
        function loadWalletData() {
             if (!currentUser) return;
             // Reset placeholders for wallet section
             removePlaceholders(elements.walletTotalBalance?.closest('.placeholder-glow'));
             removePlaceholders(elements.walletWinningCash?.closest('.placeholder-glow'));
             removePlaceholders(elements.walletBonusCash?.closest('.placeholder-glow'));
             
             // Refresh data
             populateUserInfo(currentUser, userProfile); // Ensure profile data is displayed immediately
             loadRecentTransactions();
        }
        function loadProfileData() {
             if (!currentUser) return;
             // Reset placeholders for profile section
             removePlaceholders(elements.profileName?.closest('.placeholder-glow'));
             removePlaceholders(elements.profileEmail?.closest('.placeholder-glow'));
             removePlaceholders(elements.profileTotalMatches?.closest('.placeholder-glow'));
             removePlaceholders(elements.profileWonMatches?.closest('.placeholder-glow'));
             removePlaceholders(elements.profileTotalEarnings?.closest('.placeholder-glow'));

             // Refresh data
             populateUserInfo(currentUser, userProfile);
         }
        function loadEarningsData() {
             if (!currentUser) return;
             // Reset placeholders for earnings section
             removePlaceholders(elements.earningsTotal?.closest('.placeholder-glow'));
             removePlaceholders(elements.earningsReferral?.closest('.placeholder-glow'));

             // Refresh data
             populateUserInfo(currentUser, userProfile);
        }
        async function recordTransaction(userId, type, amount, description, details = {}) {
            if (!userId) return;
            const transactionRef = ref(db, `transactions/${userId}`);
            const newTransaction = { type, amount, description, timestamp: Date.now(), ...details }; 
            try {
                await push(transactionRef, newTransaction);
            } catch (e) {
                console.error("Transaction record failed:", e);
            }
        }
        async function loadRecentTransactions() {
             if (!currentUser || !elements.recentTransactionsList) return; const limit = 5;
             elements.recentTransactionsList.innerHTML = ''; elements.recentTransactionsList.classList.add('placeholder-glow');
             for (let i = 0; i < 3; i++) elements.recentTransactionsList.innerHTML += `<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5 h-16"></span><span class="placeholder col-3 h-16"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6 h-14"></span></div></div>`; 
             if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'Loading transactions...'; }
             try {
                 const transRef = query(ref(db, `transactions/${currentUser.uid}`), limitToLast(limit));
                 const s = await get(transRef);
                 const transactions = s.val() || {};
                 const sortedT = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                 removePlaceholders(elements.recentTransactionsList);
                 elements.recentTransactionsList.innerHTML = ''; 
                 if (sortedT.length > 0) {
                     if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none';
                     sortedT.forEach(t => { 
                         const amountNum = Number(t.amount || 0); 
                         const isCredit = amountNum > 0;
                         const sign = isCredit ? '+' : (amountNum < 0 ? '' : ''); 
                         const amtDisplay = `${sign}₹${Math.abs(amountNum).toFixed(2)}`; 
                         const time = t.timestamp ? new Date(t.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'; 
                         const colorClass = isCredit ? 'text-success' : 'text-danger';
                         const item = document.createElement('div'); 
                         item.className = 'custom-card p-2 mb-2 d-flex justify-content-between align-items-center'; 
                         item.innerHTML = `
                             <div>
                                 <div class="small fw-bold">${t.description || t.type || 'Txn'}</div>
                                 <div class="small text-secondary">${time}</div>
                             </div>
                             <div class="fw-bold ${colorClass}">${amtDisplay}</div>
                         `; 
                         elements.recentTransactionsList.appendChild(item); 
                     });
                 } else if (elements.noTransactionsMessage) {
                     elements.noTransactionsMessage.style.display = 'block';
                     elements.noTransactionsMessage.textContent = 'No recent transactions.';
                 }
             } catch (e) { 
                 console.error("Transactions load failed:", e); 
                 removePlaceholders(elements.recentTransactionsList); 
                 elements.recentTransactionsList.innerHTML = '<p class="text-danger tc">Could not load transactions.</p>'; 
                 if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; 
             }
        }
        async function loadTransactionHistory() {
            if (!currentUser || !elements.policyModalBody) return;
            elements.policyModalTitle.textContent = "Transaction History";
            elements.policyModalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 text-secondary">Loading...</p></div>';
            elements.policyModalInstance.show();
            try {
                const transRef = query(ref(db, `transactions/${currentUser.uid}`), orderByChild('timestamp'));
                const s = await get(transRef);
                const transactions = s.val() || {};
                const sortedT = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                let historyHtml = '';
                if (sortedT.length > 0) {
                    historyHtml = '<div class="list-group">';
                    sortedT.forEach(t => { 
                        const amountNum = Number(t.amount || 0); 
                        const isCredit = amountNum > 0;
                        const sign = isCredit ? '+' : (amountNum < 0 ? '' : ''); 
                        const amtDisplay = `${sign}₹${Math.abs(amountNum).toFixed(2)}`; 
                        const colorClass = isCredit ? 'text-success' : 'text-danger';
                        const time = t.timestamp ? new Date(t.timestamp).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' }) : 'N/A'; 
                        historyHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-bold">${t.description || t.type || 'Transaction'}</div>
                                    <small class="text-secondary d-block">${time}</small>
                                    ${t.tournamentId ? `<small class="text-secondary d-block">Tournament ID: ${t.tournamentId.substring(0, 8)}...</small>` : ''}
                                </div>
                                <span class="fw-bold ${colorClass}" style="flex-shrink: 0; margin-left: 10px;">${amtDisplay}</span>
                            </div>
                        `;
                    });
                    historyHtml += '</div>';
                } else { historyHtml = '<p class="text-secondary text-center p-5">No transactions found.</p>'; }
                elements.policyModalBody.innerHTML = historyHtml;
            } catch (e) {
                console.error("History load failed:", e);
                elements.policyModalBody.innerHTML = '<p class="alert alert-danger text-center m-3">Error loading history. Check console/network.</p>';
            }
        }
        
        // --- Modal Handlers (Combined in this block) ---
        function handleWithdrawClick() {
             if (!currentUser || !elements.withdrawModalInstance) return;
             const wc = userProfile.winningCash || 0;
             const minW = appSettings?.minWithdraw || 50; 
             elements.minWithdrawAmount.textContent = minW;
             elements.withdrawModalBalance.textContent = `₹${wc.toFixed(2)}`;
             elements.withdrawAmountInput.value = '';
             elements.withdrawAmountInput.min = minW; 
             elements.withdrawMethodInput.value = userProfile.upiId || ''; 
             clearStatusMessage(elements.withdrawStatusMessage);
             elements.withdrawModalInstance.show();
         }
        async function submitWithdrawRequestHandler() {
             if (!currentUser || !elements.withdrawModalInstance) return;
             const amt = parseFloat(elements.withdrawAmountInput.value);
             const mtd = elements.withdrawMethodInput.value.trim();
             const wc = userProfile.winningCash || 0;
             const minW = appSettings?.minWithdraw || 50;
             clearStatusMessage(elements.withdrawStatusMessage);
             if (isNaN(amt) || amt <= 0) { showStatusMessage(elements.withdrawStatusMessage, 'Invalid amount.', 'warning'); return; }
             if (amt < minW) { showStatusMessage(elements.withdrawStatusMessage, `Min withdraw ₹${minW}.`, 'warning'); return; }
             if (amt > wc) { showStatusMessage(elements.withdrawStatusMessage, 'Insufficient winning balance.', 'warning'); return; }
             if (!mtd) { showStatusMessage(elements.withdrawStatusMessage, 'Enter withdrawal method.', 'warning'); return; }
             elements.submitWithdrawRequestBtn.disabled = true; elements.submitWithdrawRequestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
             let transactionCommitted = false; 
             try {
                 const uRef = ref(db, `users/${currentUser.uid}`);
                 const txResult = await runTransaction(uRef, (prof) => {
                     if (!prof) throw new Error("User profile missing.");
                     if ((prof.winningCash || 0) >= amt) {
                             prof.winningCash = (prof.winningCash || 0) - amt;
                             prof.balance = (prof.balance || 0) - amt; 
                             return prof;
                         } else { throw new Error("Insufficient winning balance (Tx)."); }
                 });

                  if (!txResult.committed) { throw new Error("Failed to update balance. Please try again."); }
                  transactionCommitted = true; 
                 const wrRef = ref(db, 'withdrawals');
                 const newReq = {
                     userId: currentUser.uid, userName: userProfile.displayName || currentUser.email, amount: amt,
                     methodDetails: { methodName: mtd.includes('@') ? 'UPI' : 'Bank/Other', accountInfo: mtd },
                     status: 'pending', requestTimestamp: serverTimestamp(), userEmail: currentUser.email || 'N/A'
                 };
                 const newWithdrawalRef = await push(wrRef, newReq); 
                 await recordTransaction(currentUser.uid, 'withdraw_request', -amt, `Withdrawal Request to ${mtd}`, { withdrawalId: newWithdrawalRef.key });
                 showStatusMessage(elements.withdrawStatusMessage, 'Request submitted successfully!', 'success', false);
                 setTimeout(() => { if (elements.withdrawModalInstance) elements.withdrawModalInstance.hide(); }, 2500);
                 if (currentSectionId === 'wallet-section') loadWalletData(); 
             } catch (e) {
                 showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}`, 'danger');
                 if (transactionCommitted) {
                     const uRef = ref(db, `users/${currentUser.uid}`);
                     try {
                         await runTransaction(uRef, (prof) => {
                             if (prof) { prof.winningCash = (prof.winningCash || 0) + amt; prof.balance = (prof.balance || 0) + amt; }
                             return prof;
                         });
                         await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amt, `Refund Failed Withdrawal Request`);
                         showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. Amount refunded.`, 'danger');
                         if (currentSectionId === 'wallet-section') loadWalletData(); 
                     } catch (refundError) {
                         showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. CRITICAL: Failed to refund amount! Contact support immediately.`, 'danger', false);
                     }
                 }
             } finally {
                 elements.submitWithdrawRequestBtn.disabled = false;
                 elements.submitWithdrawRequestBtn.innerHTML = 'Submit Request';
             }
         }
        async function handleMatchDetailsClick(event) {
             if (!elements.matchDetailsModalInstance) return; const tId = event.currentTarget.dataset.tournamentId; if (!tId) return;
             elements.matchDetailsModalTitle.textContent = 'Loading...'; elements.matchDetailsModalBody.innerHTML = '<div class="tc p-5"><div class="spinner-border spinner-border-sm"></div></div>';
             elements.matchDetailsModalInstance.show();
             try {
                 const tRef = ref(db, `tournaments/${tId}`);
                 const s = await get(tRef);
                 if (s.exists()) {
                     const t = s.val();
                     const gName = appSettings.games?.[t.gameId]?.name || t.gameId || 'N/A';
                     const sTimeLoc = t.startTime ? new Date(t.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short'}) : 'TBA';
                     let pDistHTML = '';
                     if (t.prizeDistribution) {
                         let fmtDist = '';
                         if (typeof t.prizeDistribution === 'object') {
                             fmtDist = Object.entries(t.prizeDistribution).map(([rank, prize]) => `Rank ${rank}: ₹${prize}`).join('\n');
                         } else { fmtDist = String(t.prizeDistribution).replace(/\n/g, '\n'); }
                         pDistHTML = `<h5>Prize Distribution:</h5><pre>${fmtDist}</pre>`;
                     }
                     const desc = t.description || 'Standard rules apply.';
                     const fmtDesc = desc.replace(/\n/g, '<br>'); 
                     elements.matchDetailsModalTitle.textContent = t.name || 'Match Details';
                     elements.matchDetailsModalBody.innerHTML = `<p><strong>Game:</strong> ${gName}</p><p><strong>Mode:</strong> ${t.mode || 'N/A'}</p><p><strong>Map:</strong> ${t.map || 'N/A'}</p><p><strong>Starts:</strong> ${sTimeLoc}</p><hr><p><strong>Entry:</strong> ${t.entryFee > 0 ? `₹${t.entryFee}` : 'Free'}</p><p><strong>Prize:</strong> ₹${t.prizePool || 0}</p><p><strong>Per Kill:</strong> ₹${t.perKillPrize || 0}</p><p><strong>Max Players:</strong> ${t.maxPlayers > 0 ? t.maxPlayers : 'Unlimited'}</p><hr><h5>Rules:</h5><div style="white-space: pre-wrap; line-height: 1.6;">${fmtDesc}</div>${pDistHTML}`;
                 } else elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Details not found.</p>';
             } catch (e) { console.error("Details load failed:", e); elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details.</p>'; }
         }
        async function handleIdPasswordClick(event) {
             if (!elements.idPasswordModalInstance) return;
             const tId = event.currentTarget.dataset.tournamentId;
             if (!tId) return;
             if (!currentUser || !userProfile?.joinedTournaments?.[tId]) { showNotification("Join the tournament first or refresh the page.", 'warning'); return; }
             elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>';
             elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>';
             elements.idPasswordModalInstance.show();
             try {
                 const tournamentRef = ref(db, `tournaments/${tId}`); 
                 const s = await get(tournamentRef);
                 removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
                 removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));
                 if (s.exists()) {
                     const tournamentData = s.val();
                      if (tournamentData.showIdPass) {
                          elements.roomIdDisplay.textContent = tournamentData.roomId || 'Not updated yet';
                          elements.roomPasswordDisplay.textContent = tournamentData.roomPassword || 'Not updated yet';
                     } else {
                         elements.roomIdDisplay.textContent = 'Hidden by Admin';
                         elements.roomPasswordDisplay.textContent = 'Hidden by Admin';
                     }
                 } else {
                     elements.roomIdDisplay.textContent = 'Not Found'; 
                     elements.roomPasswordDisplay.textContent = 'Not Found';
                 }
             } catch (e) {
                 console.error("ID/Pass fetch error:", e);
                 removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
                 removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));
                 elements.roomIdDisplay.textContent = 'Error';
                 elements.roomPasswordDisplay.textContent = 'Error';
                 showNotification("Error loading ID/Password. Check permissions or network.", 'error');
             }
         }
        async function handleJoinTournamentClick(event) {
             if (!currentUser) { showNotification("Login to join.", 'warning'); showSection('login-section'); return; }
             const btn = event.currentTarget; 
             const tId = btn.dataset.tournamentId; 
             const fee = parseFloat(btn.dataset.fee || 0);
             if (!tId) return; 
             const tSnap = await get(ref(db, `tournaments/${tId}`));
             if (!tSnap.exists()) { showNotification("Tournament not found.", 'error'); return; }
             const tData = tSnap.val();
             if (!elements.joinDetailsModalInstance) { showNotification("Modal error. Cannot proceed.", 'error'); return; }
             elements.modalTournamentName.textContent = tData.name || 'Tournament';
             elements.modalEntryFee.textContent = `₹${fee.toFixed(2)}`;
             elements.joinDetailsTournamentId.value = tId;
             const existingIGN = userProfile.inGameName || ''; 
             elements.joinDetailsInGameNameInput.value = existingIGN;
             clearStatusMessage(elements.joinDetailsStatusMessage);
             elements.submitJoinDetailsBtn.dataset.fee = fee; 
             elements.submitJoinDetailsBtn.dataset.tournamentId = tId;
             elements.joinDetailsModalInstance.show();
        }
        async function submitJoinDetailsHandler(event) {
             if (!currentUser) return;
             const btn = event.currentTarget;
             const tId = btn.dataset.tournamentId;
             const fee = parseFloat(btn.dataset.fee || 0);
             const inGameName = elements.joinDetailsInGameNameInput.value.trim();
             const statusEl = elements.joinDetailsStatusMessage;
             clearStatusMessage(statusEl);
             if (!inGameName) { showStatusMessage(statusEl, 'Please enter your In-Game Name/ID.', 'danger', false); return; }
             if (!confirm(`Confirm joining with In-Game Name: "${inGameName}" for ₹${fee.toFixed(2)}?`)) { return; }
             btn.disabled = true; 
             btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Joining...';
             const uRef = ref(db, `users/${currentUser.uid}`); 
             const tRef = ref(db, `tournaments/${tId}`);
             let tData = null; 
             let transactionResult = null; 
             try {
                 transactionResult = await runTransaction(uRef, (profileData) => {
                     if (!profileData) throw new Error("User profile missing.");
                     if ((profileData.balance || 0) < fee) throw new Error("Insufficient balance.");
                     if (profileData.joinedTournaments?.[tId]) { console.warn("Already joined (Tx check)."); return; }
                     profileData.balance = (profileData.balance || 0) - fee;
                     if (!profileData.joinedTournaments) profileData.joinedTournaments = {};
                     profileData.joinedTournaments[tId] = true; 
                     profileData.inGameName = inGameName; 
                     return profileData; 
                 });
                  if (!transactionResult.committed && userProfile?.joinedTournaments?.[tId]) { throw new Error("Already joined this tournament."); } 
                  else if (!transactionResult.committed) { throw new Error("Join transaction failed."); }
                 const snapshot = await get(tRef);
                 if (!snapshot.exists()) throw new Error("Tournament not found after transaction.");
                 tData = snapshot.val();
                  if (tData.status !== 'upcoming') throw new Error("Tournament closed after balance check.");
                  const rC = tData.registeredPlayers ? Object.keys(tData.registeredPlayers).length : 0;
                  if (tData.maxPlayers > 0 && rC >= tData.maxPlayers) throw new Error("Tournament full after balance check.");
                 const updates = {};
                 updates[`tournaments/${tId}/registeredPlayers/${currentUser.uid}`] = { joinedAt: serverTimestamp(), inGameName: inGameName };
                 await update(ref(db), updates); 
                 elements.joinDetailsModalInstance?.hide();
                 await recordTransaction(currentUser.uid, 'tournament_join', -fee, `Joined: ${tData.name || 'Tournament'} (${inGameName})`, { tournamentId: tId, inGameName: inGameName });
                 showNotification(`Joined! ₹${fee.toFixed(2)} deducted. Your IGN: ${inGameName}`, 'success');
                 const finalSnapshot = await get(tRef);
                 if (finalSnapshot.exists()) {
                     const finalTData = finalSnapshot.val();
                     const cardEl = document.querySelector(`.tournament-card[data-tournament-id="${tId}"]`); 
                     if (cardEl) { cardEl.parentNode.replaceChild(createTournamentCardElement(tId, finalTData), cardEl); } 
                     if (currentSectionId === 'tournaments-section' && currentTournamentGameId) filterTournaments(currentTournamentGameId, 'upcoming');
                     if (currentSectionId === 'home-section') loadMyContests();
                 } 
                 if (currentSectionId === 'wallet-section') loadRecentTransactions();
             } catch (e) {
                 showStatusMessage(statusEl, `Failed: ${e.message}`, 'danger', false); 
                 let refunded = false;
                 if (e.message !== "Insufficient balance." && e.message !== "User profile missing." && e.message !== "Already joined this tournament." && transactionResult?.committed) {
                     try {
                         const refundTx = await runTransaction(uRef, (profileData) => {
                             if (profileData) {
                                 profileData.balance = (profileData.balance || 0) + fee; 
                                 if(profileData.joinedTournaments?.[tId]) { delete profileData.joinedTournaments[tId]; if(Object.keys(profileData.joinedTournaments).length === 0) { delete profileData.joinedTournaments; } }
                             } return profileData;
                         });
                         if(refundTx.committed) {
                             await recordTransaction(currentUser.uid, 'join_failed_refund', fee, `Refund Failed Join: ${tData?.name || 'Tournament'}`);
                             showNotification("Join failed, but your balance was refunded.", 'warning');
                             elements.joinDetailsModalInstance?.hide();
                             refunded = true;
                         } else { throw new Error("Refund transaction failed."); }
                     } catch (refundError) {
                         showNotification(`Join failed. CRITICAL: Failed to refund balance (₹${fee.toFixed(2)})! Contact support immediately.`, 'error');
                     }
                 }
                 if (!refunded) {
                     btn.disabled = false;
                     btn.innerHTML = 'Confirm Join'; 
                 }
             }
         }
        async function handlePolicyClick(event) {
             if (!elements.policyModalInstance) { console.error("Policy modal instance not found"); return; }
             event.preventDefault();
             const target = event.currentTarget;
             const policyType = target.dataset.policy;
             if (!policyType) return;
             let title = '', modalBodyContent = '<div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
             elements.policyModalBody.innerHTML = modalBodyContent;

             switch (policyType) {
                 case 'privacy': title = 'Privacy Policy'; modalBodyContent = appSettings.policyPrivacy || 'Content not available.'; break;
                 case 'terms': title = 'Terms and Conditions'; modalBodyContent = appSettings.policyTerms || 'Content not available.'; break;
                 case 'refund': title = 'Refund and Cancellation'; modalBodyContent = appSettings.policyRefund || 'Content not available.'; break;
                 case 'fairPlay': title = 'Fair Play Policy'; modalBodyContent = appSettings.policyFairPlay || 'Content not available.'; break;
                 case 'refer':
                     title = 'Refer & Earn';
                     if (!currentUser) { showNotification("Login to view referral.", 'warning'); return; }
                     const refCode = userProfile.referralCode || 'N/A';
                     const refBonus = appSettings?.referralBonus || 0; 
                     const refDesc = appSettings?.referralDescription || `Get ₹${refBonus} when your friend joins using your code.`; 
                     modalBodyContent = `<div class="text-center"><h4>Refer Friends!</h4><p class="text-secondary">Share code & earn!</p><div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="small text-secondary mb-1">Your Code:</p><h3 class="text-accent referral-code" id="referralCodeDisplay">${refCode}</h3><div class="mt-3"><button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-secondary">${refDesc}</p></div>`;
                     break;
                 default:
                     title = 'Info';
                     modalBodyContent = '<p>Content unavailable.</p>';
             }

             elements.policyModalTitle.textContent = title;
             if (typeof modalBodyContent === 'string' && policyType !== 'refer') {
                 elements.policyModalBody.innerHTML = modalBodyContent.replace(/\n/g, '<br>');
             } else {
                 elements.policyModalBody.innerHTML = modalBodyContent; 
             }
             elements.policyModalInstance.show();
         }

        // *** NEW: Notification Functions ***

        /**
         * Loads and displays all notifications, updates the last seen timestamp.
         */
        async function loadAndDisplayNotifications() {
            if (!currentUser || !elements.notificationListModalInstance || !elements.notificationListBody) return;

            elements.notificationListBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 text-secondary">Loading notifications...</p></div>';
            elements.notificationListModalInstance.show();
            
            try {
                // Fetch all notifications, ordered by timestamp descending
                const q = query(ref(db, 'notifications'), orderByChild('timestamp'));
                const snapshot = await get(q);
                const notifications = snapshot.val() || {};

                // Convert to array and sort (Firebase query already handles order byChild, but final sort ensures timestamp order)
                const sortedNotifs = Object.entries(notifications)
                    .map(([key, val]) => ({ id: key, ...val }))
                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                let notifHtml = '';
                let newNotifCount = 0;
                const lastSeen = userProfile.lastSeenNotificationsTimestamp || 0;
                
                if (sortedNotifs.length > 0) {
                    sortedNotifs.forEach(n => {
                        // [FIX START] Define a robust message variable to check for 'message', 'body', or a default
                        const messageContent = n.message || n.body || 'No message content available.';
                        // [FIX END]
                        
                        const isNew = (n.timestamp > lastSeen);
                        if (isNew) newNotifCount++;
                        
                        const timeString = n.timestamp ? new Date(n.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A';
                        
                        notifHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-start ${isNew ? 'bg-secondary' : ''}">
                                <div>
                                    <div class="fw-bold">${n.title || 'Notification'} ${isNew ? '<span class="badge bg-danger ms-2">NEW</span>' : ''}</div>
                                    <small class="text-secondary d-block">${messageContent}</small>
                                    <small class="text-muted">${timeString}</small>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    notifHtml = '<div class="text-center p-5 text-secondary">No global notifications found.</div>';
                }

                elements.notificationListBody.innerHTML = notifHtml;

                // Update last seen timestamp in user profile on modal display
                if (currentUser && lastSeen < Date.now()) {
                    await update(ref(db, `users/${currentUser.uid}`), { lastSeenNotificationsTimestamp: Date.now() });
                }
                
                // Final update to local state and badge after successful fetch/update
                unreadNotificationCount = 0;
                updateNotificationBadge();
                
            } catch (e) {
                console.error("Error loading notifications:", e);
                elements.notificationListBody.innerHTML = '<div class="text-center p-5 text-danger">Error loading notifications. Check rules.</div>';
            }
        }

        /**
         * Checks the total number of notifications greater than the user's lastSeenTimestamp.
         */
        function checkUnreadNotifications(lastSeenTimestamp) {
            if (!db || !elements.notificationBadge) return;
            
            // Query: notifications ordered by timestamp, only fetch those newer than lastSeenTimestamp
            const notifsRef = ref(db, 'notifications');
            // We use onValue on the whole node, but filter and count manually.
            // For a large database, a dedicated counter in admin should be used, but this is simpler.
            
            const listenerKey = 'globalNotifications';
            // Detach previous listener if exists (from a previous login/session)
            if (dbListeners[listenerKey]?.func) { 
                off(notifsRef, 'value', dbListeners[listenerKey].func);
                delete dbListeners[listenerKey];
            }
            
            const listFunc = onValue(notifsRef, (snapshot) => {
                let count = 0;
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const timestamp = childSnapshot.val().timestamp || 0;
                        if (timestamp > lastSeenTimestamp) {
                            count++;
                        }
                    });
                }
                unreadNotificationCount = count;
                updateNotificationBadge();
            }, (error) => {
                console.error("Realtime notification listener failed:", error);
                unreadNotificationCount = -1; // Indicate error
                updateNotificationBadge();
            });

            dbListeners[listenerKey] = { path: 'notifications', func: listFunc };
            console.log("Attached real-time notification listener.");
        }

        /**
         * Updates the header badge based on the unreadNotificationCount state.
         */
        function updateNotificationBadge() {
            if (!elements.notificationBadge) return;

            if (unreadNotificationCount > 0) {
                elements.notificationBadge.textContent = unreadNotificationCount > 9 ? '9+' : unreadNotificationCount;
                elements.notificationBadge.style.display = 'flex';
                // Optional: Play a sound or flash the icon if a new notification arrived.
            } else {
                elements.notificationBadge.style.display = 'none';
            }
        }
        // *** END NEW: Notification Functions ***
        
        // --- Realtime Listeners Setup ---
         function setupRealtimeListeners(uid) {
             if (!uid || !db || !currentUser) return;
             detachAllDbListeners(); 
             
             // 1. User Profile Listener
             const uRef = ref(db, `users/${uid}`);
             const listFunc = onValue(uRef, (s) => {
                 if (currentUser && currentUser.uid === uid) { 
                     if (s.exists()) {
                         userProfile = s.val();
                         populateUserInfo(currentUser, userProfile); 
                         // Check unread notifications whenever user profile updates (especially lastSeenNotificationsTimestamp)
                         checkUnreadNotifications(userProfile.lastSeenNotificationsTimestamp || 0); 

                         if (currentSectionId === 'home-section') loadHomePageData();
                         if (currentSectionId === 'wallet-section') loadRecentTransactions(); 
                     } else {
                         showNotification("Account data missing or deleted. Logging out.", 'error');
                         logoutUser();
                     }
                 } else {
                     off(uRef, 'value', listFunc); 
                 }
             }, (e) => {
                 if (e.message && e.message.includes('permission_denied')) {
                     console.error("CRITICAL Listener error (user profile): PERMISSION_DENIED. Check Database Rules for /users/{uid}.", e);
                     showNotification("Error loading real-time profile data (Permission Denied). Check Firebase Rules.", 'error');
                 } else {
                     console.error("Listener error (user profile):", e);
                 }
             });
             dbListeners['userProfile'] = { path: `users/${uid}`, func: listFunc };
             
             // 2. Global Notifications Listener is handled within checkUnreadNotifications now
         }
         function detachAllDbListeners() {
             let count = 0;
             for (const k in dbListeners) {
                 try {
                     const { path, func } = dbListeners[k];
                     if (path && func) {
                          off(ref(db, path), 'value', func);
                          count++;
                     } else {
                         console.warn(`Listener object invalid for key: ${k}`);
                     }
                 } catch (e) { console.error(`Detach error ${k}:`, e); }
             }
             dbListeners = {};
         }

        // --- Event Listeners Initialization ---
         function initializeEventListeners() {
             if (!elements) return; 

             // --- NEW: Lamp and Mode Toggles ---
             if (elements.lampToggle) elements.lampToggle.addEventListener('click', glowLamp);
             
             elements.modeBtns?.forEach(btn => btn.addEventListener('click', (e) => {
                 const mode = e.currentTarget.dataset.mode;
                 toggleLoginForm(mode === 'login');
             }));
             
             // --- NEW: Password Strength and Toggles ---
             if (elements.newPasswordInput) elements.newPasswordInput.addEventListener('input', updatePasswordStrength);

             if (elements.toggleLoginPassword) elements.toggleLoginPassword.addEventListener('click', () => {
                 togglePasswordVisibility(elements.loginPasswordInput, elements.toggleLoginPassword);
             });
             if (elements.toggleNewPassword) elements.toggleNewPassword.addEventListener('click', () => {
                 togglePasswordVisibility(elements.newPasswordInput, elements.toggleNewPassword);
             });
             if (elements.toggleConfirmPassword) elements.toggleConfirmPassword.addEventListener('click', () => {
                 togglePasswordVisibility(elements.signupConfirmPasswordInput, elements.toggleConfirmPassword);
             });
             
             // --- Auth Form Actions (Original calls remain) ---
             elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
             elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
             elements.forgotPasswordLink?.addEventListener('click', (e) => { e.preventDefault(); resetPassword(); });

             // Bottom Nav (Calls showSection, which handles data loading)
             elements.bottomNavItems?.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); showSection(item.dataset.section); }));
             // Header Back
             elements.headerBackBtn?.addEventListener('click', () => showSection('home-section'));
             // Tournament Tabs
             elements.tournamentTabs?.forEach(tab => tab.addEventListener('click', (e) => { const s = e.currentTarget.dataset.status; if (currentTournamentGameId && s) { elements.tournamentTabs.forEach(t => t.classList.remove('active')); e.currentTarget.classList.add('active'); filterTournaments(currentTournamentGameId, s); } }));
             // Profile Actions
             elements.logoutProfileBtn?.addEventListener('click', logoutUser);
             elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick)); 
             elements.notificationSwitch?.addEventListener('change', (e) => { console.log("Notification toggle:", e.target.checked); });

             // Wallet Actions
             elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
             elements.addAmountWalletBtn?.addEventListener('click', () => { if (currentUser && elements.addAmountModalInstance) { if(elements.modalUserEmail) elements.modalUserEmail.textContent = currentUser.email || 'N/A'; elements.addAmountModalInstance.show(); } else if (!currentUser) { showNotification("Login first.", 'warning'); showSection('login-section'); } });
             elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);
             
             // Join Modal Submission
             elements.submitJoinDetailsBtn?.addEventListener('click', submitJoinDetailsHandler);

             // Other Actions
             // *** MODIFIED: Notification Button to open modal ***
             elements.notificationBtn?.addEventListener('click', () => {
                 if (currentUser) {
                     loadAndDisplayNotifications();
                 } else {
                     showNotification('Login to view notifications.', 'warning');
                 }
             });
             elements.allTransactionsBtn?.addEventListener('click', loadTransactionHistory);
             elements.viewEarningsHistoryBtn?.addEventListener('click', loadTransactionHistory);

             // Delegated Event Listener for Copy/Share buttons
             document.body.addEventListener('click', (event) => {
                if (event.target.matches('.copy-btn') || event.target.closest('.copy-btn')) {
                    const btn = event.target.closest('.copy-btn');
                    const targetSelector = btn.dataset.target; 
                    if (targetSelector) { copyToClipboard(targetSelector); } 
                    else { console.warn("Copy button missing data-target selector."); }
                }
                if (event.target.matches('#shareReferralBtn') || event.target.closest('#shareReferralBtn')) {
                    const cel = getElement('referralCodeDisplay');
                    if (cel) shareReferral(cel.textContent);
                }
             });
             console.log("Listeners initialized.");
         }

        // --- App Initialization ---
         document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM Loaded. Init App...");
             if (!auth || !db) {
                 document.body.innerHTML = `<div class="alert alert-danger m-5 position-fixed top-0 start-0 end-0" style="z-index: 10000;">Critical Error: Firebase SDK failed/not ready.</div>`;
                 return;
             }
             showLoader(true);
             loadAppSettings()
                 .then(() => {
                     console.log("Settings loaded, initializing listeners and auth state...");
                 })
                 .catch(err => {
                     // FIX: Show a non-blocking notification instead of a blocking alert, but keep the console log
                     console.error("CRITICAL: Initial settings load failed:", err);
                     showNotification("Warning: Could not load app settings. Some features may be affected. Check console for details.", 'warning');
                 })
                 .finally(() => {
                     // FIX: Always proceed to initialize auth state listener regardless of settings loading success
                     initializeEventListeners();
                     updateGlobalUI(false); 
                     
                     // Ensure the correct class is set for initial rendering
                     if (getElement('login-section')?.classList.contains('active')) {
                        document.body.classList.add('login-active');
                     }
                     
                     onAuthStateChanged(auth, handleAuthStateChange); 
                     setTimeout(() => { glowLamp(); }, 1000); 
                 });
         });

    </script>

</body>
</html>
